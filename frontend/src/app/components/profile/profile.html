@if (!loading) {
  <div class="profile-wrapper">
    <header class="profile-header">
      <h1><i class="fas fa-user-circle"></i> H·ªì s∆° ng∆∞·ªùi d√πng</h1>
      <a routerLink="/home" class="btn-link">
        <i class="fas fa-home"></i> V·ªÅ trang ch·ªß
      </a>
    </header>
    <nav class="profile-tabs">
      <button
        type="button"
        [class.active]="active_tab === 'INFO'"
        (click)="setTab('INFO')">
        <i class="fas fa-id-card"></i> Th√¥ng tin
      </button>

      <button
        type="button"
        [class.active]="active_tab === 'ACHIEVEMENTS'"
        (click)="setTab('ACHIEVEMENTS')">
        <i class="fas fa-trophy"></i> Th√†nh t√≠ch & ti·∫øn tr√¨nh
      </button>

      <button
        type="button"
        [class.active]="active_tab === 'ANALYSIS'"
        (click)="setTab('ANALYSIS')"
      >
        <i class="fas fa-chart-pie"></i>
        Ph√¢n t√≠ch ch·ªß ƒë·ªÅ
      </button>


      <!-- Sau n√†y b·∫°n mu·ªën th√™m tab Ph√¢n t√≠ch th√¨ th√™m 1 n√∫t n·ªØa ·ªü ƒë√¢y -->
    </nav>

    @if (active_tab === 'INFO') {
      <div class="profile-grid">
        <!-- üñºÔ∏è ·∫¢nh ƒë·∫°i di·ªán -->
        <section class="card avatar-card">
          <h3><i class="fas fa-camera"></i> ·∫¢nh ƒë·∫°i di·ªán</h3>

          <div class="avatar-box">
            <img
              [src]="avatarPreview || 'assets/images/default-profile-image.jpeg'"
              alt="avatar"
            />
          </div>

          <label class="btn btn-outline">
            <input
              type="file"
              accept="image/*"
              (change)="onAvatarSelected($event)"
              hidden
            />
            <i
              class="fas"
              [class.fa-spinner]="uploading"
              [class.fa-spin]="uploading"
              [class.fa-upload]="!uploading"
            ></i>
            {{ uploading ? 'ƒêang t·∫£i...' : 'Ch·ªçn ·∫£nh m·ªõi' }}
          </label>
          <p class="hint">ƒê·ªãnh d·∫°ng JPG/PNG, t·ªëi ƒëa 10MB</p>
        </section>

        <!-- üë§ Th√¥ng tin c√° nh√¢n -->
        <section class="card info-card">
          <h3><i class="fas fa-id-card"></i> Th√¥ng tin c√° nh√¢n</h3>

          <form #infoForm="ngForm" (ngSubmit)="onSaveInfo(infoForm)">
            <div class="form-grid">
              <div class="form-row">
                <label>T√™n ƒëƒÉng nh·∫≠p</label>
                <input type="text" [value]="me?.ten_dang_nhap" disabled/>
              </div>

              <div class="form-row">
                <label>Vai tr√≤</label>
                <input
                  type="text"
                  [value]="me?.vai_tro?.ten_vai_tro || 'Ng∆∞·ªùi d√πng'"
                  disabled
                />
              </div>

              <div class="form-row">
                <label>Email</label>
                <input
                  type="email"
                  [(ngModel)]="updateDto.email"
                  name="email"
                  disabled
                />
              </div>

              <div class="form-row">
                <label>H·ªç v√† t√™n</label>
                <input
                  type="text"
                  [(ngModel)]="updateDto.ho_ten"
                  name="ho_ten"
                  maxlength="100"
                  placeholder="VD: Nguy·ªÖn VƒÉn A"
                />
              </div>

              <div class="form-row">
                <label>T√™n hi·ªÉn th·ªã</label>
                <input
                  type="text"
                  [(ngModel)]="updateDto.ten_hien_thi"
                  name="ten_hien_thi"
                  maxlength="100"
                  placeholder="T√™n hi·ªÉn th·ªã c√¥ng khai"
                />
              </div>

              <!--            <div class="form-row full">-->
              <!--              <label>ƒê·ªãa ch·ªâ</label>-->
              <!--              <input-->
              <!--                type="text"-->
              <!--                [(ngModel)]="updateDto.dia_chi"-->
              <!--                name="dia_chi"-->
              <!--                maxlength="255"-->
              <!--                placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£..."-->
              <!--              />-->
              <!--            </div>-->
              <div class="form-row full">
                <label>ƒê·ªãa ch·ªâ</label>
                <app-address-selector (addressChange)="updateDto.dia_chi = $event"></app-address-selector>

                <input
                  type="text"
                  [(ngModel)]="updateDto.dia_chi"
                  name="dia_chi"
                  readonly
                  placeholder="ƒê·ªãa ch·ªâ ƒë√£ ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y"
                />
              </div>
            </div>

            <div class="action-row">
              <button
                class="btn btn-green"
                type="submit"
                [disabled]="saving || infoForm.invalid"
              >
                <i
                  class="fas"
                  [class.fa-spinner]="saving"
                  [class.fa-spin]="saving"
                  [class.fa-save]="!saving"
                ></i>
                {{ saving ? 'ƒêang l∆∞u...' : 'L∆∞u thay ƒë·ªïi' }}
              </button>
            </div>
          </form>
        </section>

        <!-- üîë ƒê·ªïi m·∫≠t kh·∫©u -->
        <section class="card password-card">
          <h3><i class="fas fa-lock"></i> ƒê·ªïi m·∫≠t kh·∫©u</h3>

          <form #passwordForm="ngForm" (ngSubmit)="onChangePassword(passwordForm)">
            <div class="form-row">
              <label>M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
              <input
                type="password"
                name="oldPassword"
                [(ngModel)]="passwordModel.oldPassword"
                required
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              />
            </div>

            <div class="form-row">
              <label>M·∫≠t kh·∫©u m·ªõi</label>
              <input
                type="password"
                name="newPassword"
                [(ngModel)]="passwordModel.newPassword"
                required
                minlength="6"
                placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±"
              />
            </div>

            <div class="form-row">
              <label>Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi</label>
              <input
                type="password"
                name="retypePassword"
                [(ngModel)]="passwordModel.retypePassword"
                required
                placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
              />
            </div>

            <div class="action-row">
              <button
                class="btn btn-blue"
                type="submit"
                [disabled]="changingPass"
              >
                <i
                  class="fas"
                  [class.fa-spinner]="changingPass"
                  [class.fa-spin]="changingPass"
                  [class.fa-key]="!changingPass"
                ></i>
                {{ changingPass ? 'ƒêang ƒë·ªïi...' : 'ƒê·ªïi m·∫≠t kh·∫©u' }}
              </button>
            </div>
          </form>
        </section>
      </div>
    }
    @if (active_tab === 'ACHIEVEMENTS') {
      <div class="profile-grid achievements-grid">
        <!-- B√™n tr√°i: Ti·∫øn tr√¨nh & ch·ªâ s·ªë -->
        <section class="card stats-card">
          <h3><i class="fas fa-chart-line"></i> Ti·∫øn tr√¨nh & ch·ªâ s·ªë</h3>

          @if (user_summary) {
            <div class="stats-grid">
              <div class="stat-box">
                <div class="stat-label">Level</div>
                <div class="stat-value">Lv. {{ user_summary.level }}</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">T·ªïng EXP</div>
                <div class="stat-value">{{ user_summary.xp_in_current_level | number }}</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Rank hi·ªán t·∫°i</div>
                <div class="stat-value">{{ user_summary.rank_tier }}</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">V√†ng hi·ªán c√≥</div>
                <div class="stat-value">{{ user_summary.tien_vang | number }} ü™ô</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">T·ªïng tr·∫≠n</div>
                <div class="stat-value">{{ user_summary.tong_tran }}</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Th·∫Øng / Thua</div>
                <div class="stat-value">
                  {{ user_summary.so_tran_thang }}/{{ user_summary.so_tran_thua }}
                </div>
              </div>
            </div>

            <p class="stats-hint">
              C√°c ch·ªâ s·ªë n√†y ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau m·ªói tr·∫≠n ƒë·∫•u x·∫øp h·∫°ng.
            </p>
          } @else {
            <div class="empty-state">
              <i class="fas fa-info-circle"></i>
              <p>
                Ch∆∞a c√≥ d·ªØ li·ªáu ti·∫øn tr√¨nh. H√£y ch∆°i m·ªôt v√†i tr·∫≠n x·∫øp h·∫°ng ƒë·ªÉ h·ªá th·ªëng th·ªëng k√™ cho b·∫°n nh√©!
              </p>
            </div>
          }
        </section>

        <!-- B√™n ph·∫£i: Th√†nh t√≠ch -->
        <section class="card achievements-card">
          <h3><i class="fas fa-medal"></i> Th√†nh t√≠ch</h3>

          @if (loading_achievements) {
            <div class="empty-state">
              <i class="fas fa-spinner fa-spin"></i>
              <p>ƒêang t·∫£i th√†nh t√≠ch...</p>
            </div>
          } @else {
            @if (achievements.length === 0) {
              <div class="empty-state">
                <p>B·∫°n ch∆∞a m·ªü kh√≥a th√†nh t√≠ch n√†o. C·ª© ch∆°i v√† leo rank, th√†nh t√≠ch s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c th√™m v√†o ƒë√¢y!</p>
              </div>
            } @else {
              <div class="achievement-grid">
                @for (a of achievements; track a.code) {
                  <div class="achievement-card">
                    <div class="badge-icon">
                      <i class="fas fa-trophy"></i>
                    </div>
                    <div class="badge-content">
                      <h4>{{ a.title }}</h4>
                      <p>{{ a.description }}</p>
                      <small>
                        ƒê·∫°t ƒë∆∞·ª£c l√∫c {{ a.mo_khoa_luc | date:'dd/MM/yyyy HH:mm' }}
                      </small>
                    </div>
                  </div>
                }
              </div>
            }
          }
        </section>
      </div>
    } @else if (active_tab === 'ANALYSIS') {
      @if (loading_topics) {
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...
        </div>
      } @else {
        @if (topic_stats.length === 0) {
          <div class="empty-state">
            <i class="fas fa-info-circle"></i>
            <p>
              Ch∆∞a c√≥ ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch. H√£y ch∆°i m·ªôt v√†i tr·∫≠n ho·∫∑c luy·ªán t·∫≠p th√™m ƒë·ªÉ h·ªá th·ªëng hi·ªÉu ƒëi·ªÉm m·∫°nh/y·∫øu
              c·ªßa b·∫°n nh√©!
            </p>
          </div>
        } @else {
          <div class="topic-analysis">
            <p class="analysis-intro">
              D∆∞·ªõi ƒë√¢y l√† t·ªâ l·ªá tr·∫£ l·ªùi ƒë√∫ng theo t·ª´ng ch·ªß ƒë·ªÅ. H·ªá th·ªëng ph√¢n lo·∫°i th√†nh
              <strong>M·∫°nh</strong>, <strong>Trung b√¨nh</strong> v√† <strong>Y·∫øu</strong>.
            </p>

            <div class="topic-list">
              @for (t of topic_stats; track t.chu_de_id) {
                <div class="topic-row" [ngClass]="t.danh_gia.toLowerCase()">
                  <div class="topic-header">
                    <div class="topic-name">
                      <span class="pill" [ngClass]="t.danh_gia.toLowerCase()">
                        @if (t.danh_gia === 'MANH') {
                          M·∫°nh
                        } @else if (t.danh_gia === 'TRUNG_BINH') {
                          Trung b√¨nh
                        } @else {
                          Y·∫øu
                        }
                      </span>
                      <strong>{{ t.chu_de_ten }}</strong>
                    </div>
                    <div class="topic-meta">
                      <span>{{ t.so_cau_dung }}/{{ t.tong_cau }} c√¢u ƒë√∫ng</span>
                      <span>{{ t.ti_le_dung | number:'1.0-1' }}%</span>
                    </div>
                  </div>

                  <div class="topic-progress">
                    <div class="progress-bar">
                      <div
                        class="progress-fill"
                        [style.width.%]="t.ti_le_dung"
                      ></div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      }
    }

  </div>
} @else {
  <div class="loading">
    <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i h·ªì s∆°...
  </div>
}

