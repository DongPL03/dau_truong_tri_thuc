<div class="practice-page">
  <div class="bg-decor-1"></div>
  <div class="bg-decor-2"></div>

  <div class="container animate-fade-down">

    @if (!playing() && !finished()) {
      <header class="training-hero">
        <div class="hero-left">
          <div class="icon-dojo">ü•ã</div>
          <div class="text-content">
            <h1>Trung T√¢m Hu·∫•n Luy·ªán</h1>
            <p>R√®n luy·ªán k·ªπ nƒÉng, chinh ph·ª•c ƒë·ªânh cao tri th·ª©c m·ªói ng√†y.</p>
          </div>
        </div>

        <div class="control-panel card-3d">
          <form #f="ngForm" (ngSubmit)="onStart(f)" class="control-form">
            <div class="input-group">
              <label><i class="fas fa-book"></i> Ch·ªçn b·ªô ƒë·ªÅ:</label>
              <div class="select-wrapper">
                <select name="bo_cau_hoi_id" [(ngModel)]="bo_cau_hoi_id">
                  <option [ngValue]="null">-- Ch·ªçn b·ªô c√¢u h·ªèi --</option>
                  @for (bo of bo_cau_hoi_options(); track bo.id) {
                    <option [ngValue]="bo.id">{{ bo.tieu_de }}</option>
                  }
                </select>
                <i class="fas fa-chevron-down arrow"></i>
              </div>
            </div>

            <div class="action-buttons">
              <button class="btn-start" type="submit" [disabled]="loading() || !bo_cau_hoi_id">
                @if (loading()) {
                  <i class="fas fa-spinner fa-spin"></i>
                } @else {
                  <i class="fas fa-play"></i> B·∫ÆT ƒê·∫¶U NGAY
                }
              </button>

              <button class="btn-memo" type="button" (click)="onStartFromMemo()"
                      [disabled]="loading() || !bo_cau_hoi_id">
                <i class="fas fa-brain"></i> √în t·ª´ th·∫ª nh·ªõ
              </button>
            </div>
          </form>
        </div>
      </header>

      <div class="stats-area animate-fade-up">

        <section class="section-card">
          <div class="section-header">
            <h3><i class="fas fa-history"></i> L·ªãch s·ª≠ ƒë·∫•u t·∫≠p</h3>
            <div class="filters">
              <select [(ngModel)]="filterBoCauHoiId" (change)="loadHistory(0)" class="mini-select">
                <option [ngValue]="null">T·∫•t c·∫£ b·ªô ƒë·ªÅ</option>
                @for (bo of bo_cau_hoi_options(); track bo.id) {
                  <option [ngValue]="bo.id">{{ bo.tieu_de }}</option>
                }
              </select>
            </div>
          </div>

          <div class="table-responsive custom-scrollbar">
            <table class="modern-table">
              <thead>
              <tr>
                <th>Th·ªùi gian</th>
                <th>B·ªô ƒë·ªÅ</th>
                <th class="text-center">ƒêi·ªÉm</th>
                <th class="text-center">K·∫øt qu·∫£</th>
                <th class="text-center">ƒê·ªô ch√≠nh x√°c</th>
                <th></th>
              </tr>
              </thead>
              <tbody>
                @if (history_items().length === 0) {
                  <tr>
                    <td colspan="6" class="text-center text-muted">Ch∆∞a c√≥ l·ªãch s·ª≠ luy·ªán t·∫≠p</td>
                  </tr>
                }
                @for (h of history_items(); track h.phien_id) {
                  <tr>
                    <td>
                      <div class="date-col">
                        <span class="d-date">{{ h.ngay_tao | date:'dd/MM' }}</span>
                        <span class="d-time">{{ h.ngay_tao | date:'HH:mm' }}</span>
                      </div>
                    </td>
                    <td class="title-col">{{ h.bo_cau_hoi }}</td>
                    <td class="text-center font-bold text-primary">{{ h.diem_so }}</td>
                    <td class="text-center">{{ h.so_cau_dung }}/{{ h.tong_cau_hoi }}</td>
                    <td class="text-center">
                      <span class="accuracy-badge" [ngClass]="getAccuracyClass(h.do_chinh_xac)">{{ h.do_chinh_xac }}
                        %</span>
                    </td>
                    <td class="text-right">
                      <button class="btn-retry" (click)="retryHistory(h)" title="Luy·ªán t·∫≠p l·∫°i b·ªô n√†y">
                        <i class="fas fa-redo"></i> Luy·ªán l·∫°i
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          @if (totalPagesHistory > 1) {
            <div class="pagination-simple">
              <button (click)="changePage(pageHistory - 1)" [disabled]="pageHistory === 0"><i
                class="fas fa-chevron-left"></i></button>
              <span>{{ pageHistory + 1 }} / {{ totalPagesHistory }}</span>
              <button (click)="changePage(pageHistory + 1)" [disabled]="pageHistory === totalPagesHistory - 1"><i
                class="fas fa-chevron-right"></i></button>
            </div>
          }
        </section>

        <section class="section-card mt-4">
          <div class="section-header">
            <h3><i class="fas fa-lightbulb"></i> Th·∫ª ghi nh·ªõ (Flashcards)</h3>
            <p class="subtitle">Nh·ªØng c√¢u h·ªèi b·∫°n l√†m sai s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y ƒë·ªÉ √¥n t·∫≠p</p>
          </div>

          @if (memo_items().length === 0) {
            <div class="empty-memo">
              <img src="assets/images/empty-box.png" onerror="this.style.display='none'">
              <p>H·ªôp th·∫ª ghi nh·ªõ ƒëang tr·ªëng. B·∫°n ƒë√£ l√†m r·∫•t t·ªët!</p>
            </div>
          } @else {
            <div class="flashcard-grid">
              @for (m of memo_items(); track m.memo_id) {
                <div class="flash-card">
                  <div class="fc-header">
                    <span class="fc-date">{{ m.tao_luc | date:'dd/MM' }}</span>
                    <button class="btn-icon-del" (click)="deleteMemoConfirm(m)" title="X√≥a th·∫ª">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <div class="fc-body">
                    <h4 class="fc-question">{{ m.cau_hoi }}</h4>
                    <div class="fc-answer">
                      <span class="lbl">ƒê√°p √°n:</span> {{ m.dap_an_dung }}
                    </div>
                    @if (m.giai_thich) {
                      <div class="fc-explain"><i class="fas fa-info-circle"></i> {{ m.giai_thich }}</div>
                    }
                  </div>
                  <div class="fc-footer">
                    <button class="btn-practice-one" (click)="practiceSingleFromMemo(m)">Luy·ªán c√¢u n√†y</button>
                  </div>
                </div>
              }
            </div>
            @if (totalPagesMemo > 1) {
              <div class="pagination-simple">
                <button (click)="changePageMemo(pageMemo - 1)" [disabled]="pageMemo === 0"><i
                  class="fas fa-chevron-left"></i></button>
                <span>{{ pageMemo + 1 }} / {{ totalPagesMemo }}</span>
                <button (click)="changePageMemo(pageMemo + 1)" [disabled]="pageMemo === totalPagesMemo - 1"><i
                  class="fas fa-chevron-right"></i></button>
              </div>
            }
          }
        </section>
      </div>
    }

    @if (playing() && currentQuestion(); as q) {
      <div class="gameplay-wrapper animate-scale-up">

        <div class="game-header">
          <div class="game-info">
            <span class="game-set">{{ practice_data()?.bo_cau_hoi }}</span>
            <div class="game-progress">
              C√¢u <span class="current">{{ current_index() + 1 }}</span> / {{ practice_data()?.tong_cau_hoi }}
            </div>
          </div>
          <div class="game-timer" [class.urgent]="remaining_seconds() <= 5">
            <i class="far fa-clock"></i> {{ remaining_seconds() }}s
          </div>
        </div>

        <div class="game-card">
          <div class="q-content">
            <h3 class="q-text">{{ q.noi_dung }}</h3>

            @if (q.duong_dan_tep && q.loai_noi_dung !== 'VAN_BAN') {
              <div class="q-media">
                @switch (q.loai_noi_dung) {
                  @case ('HINH_ANH') {
                    <img [src]="environment.apiBaseUrl + '/cauHoi/media/' + q.duong_dan_tep">
                  }
                  @case ('AM_THANH') {
                    <audio controls [src]="environment.apiBaseUrl + '/cauHoi/media/' + q.duong_dan_tep"></audio>
                  }
                }
              </div>
            }
          </div>

          <div class="q-choices">
            <button class="choice-btn" [class.selected]="currentAnswer() === 'A'" (click)="selectAnswer('A')">
              <span class="label">A</span>
              <span class="text">{{ q.lua_chon_a }}</span>
            </button>
            <button class="choice-btn" [class.selected]="currentAnswer() === 'B'" (click)="selectAnswer('B')">
              <span class="label">B</span>
              <span class="text">{{ q.lua_chon_b }}</span>
            </button>
            <button class="choice-btn" [class.selected]="currentAnswer() === 'C'" (click)="selectAnswer('C')">
              <span class="label">C</span>
              <span class="text">{{ q.lua_chon_c }}</span>
            </button>
            <button class="choice-btn" [class.selected]="currentAnswer() === 'D'" (click)="selectAnswer('D')">
              <span class="label">D</span>
              <span class="text">{{ q.lua_chon_d }}</span>
            </button>
          </div>

          <div class="game-footer">
            <button class="btn-nav prev" (click)="goPrev()" [disabled]="current_index() === 0">
              <i class="fas fa-arrow-left"></i> Tr∆∞·ªõc
            </button>

            <button class="btn-submit" (click)="submitCurrentQuestion()" [disabled]="submitting()">
              @if (current_index() >= (practice_data()?.tong_cau_hoi || 1) - 1) {
                <i class="fas fa-flag-checkered"></i> N·ªòP B√ÄI
              } @else {
                Ti·∫øp theo <i class="fas fa-arrow-right"></i>
              }
            </button>
          </div>
        </div>
      </div>
    }

    @if (finished() && result(); as r) {
      <div class="result-container animate-fade-down">
        <div class="result-card">
          <div class="result-header">
            <h2>T·ªïng K·∫øt Phi√™n Luy·ªán T·∫≠p</h2>
            <div class="score-circle">
              <span class="score-val">{{ r.diem_so }}</span>
              <span class="score-lbl">ƒêi·ªÉm</span>
            </div>
          </div>

          <div class="result-stats">
            <div class="rs-item success">
              <i class="fas fa-check-circle"></i>
              <span>ƒê√∫ng: {{ r.so_cau_dung }}/{{ r.tong_so_cau }}</span>
            </div>
            <div class="rs-item info">
              <i class="fas fa-crosshairs"></i>
              <span>Ch√≠nh x√°c: {{ r.do_chinh_xac }}%</span>
            </div>
            <div class="rs-item warning">
              <i class="fas fa-stopwatch"></i>
              <span>T·ªëc ƒë·ªô: {{ (r.thoi_gian_tb_ms || 0) / 1000 | number:'1.1-1' }}s/c√¢u</span>
            </div>
          </div>

          <div class="result-actions">
            <button class="btn-primary"
                    (click)="current_index.set(0); playing.set(false); finished.set(false); loadHistory(0); loadMemos(0)">
              <i class="fas fa-home"></i> Quay v·ªÅ trang ch·ªß
            </button>
            <button class="btn-outline" (click)="current_index.set(0); playing.set(true); finished.set(false)">
              <i class="fas fa-redo"></i> Xem l·∫°i b√†i l√†m
            </button>
          </div>

          <div class="result-details">
            <h3>Chi ti·∫øt ƒë√°p √°n</h3>
            <div class="rd-list">
              @for (d of r.chi_tiet; track $index) {
                <div class="rd-row" [class.correct]="d.dung_hay_sai" [class.wrong]="!d.dung_hay_sai">
                  <span class="rd-idx">#{{ $index + 1 }}</span>
                  <div class="rd-info">
                    <p class="rd-q">{{ practice_data()?.cau_hoi_list?.[$index]?.noi_dung }}</p>
                    <div class="rd-ans">
                      <span class="your-ans">B·∫°n ch·ªçn: <strong>{{ d.lua_chon || 'B·ªè qua' }}</strong></span>
                      <span class="real-ans">ƒê√°p √°n: <strong>{{ d.dap_an_dung }}</strong></span>
                    </div>
                    @if (!d.dung_hay_sai && d.giai_thich) {
                      <p class="rd-explain"><i class="fas fa-lightbulb"></i> {{ d.giai_thich }}</p>
                    }
                  </div>
                  <div class="rd-icon">
                    @if (d.dung_hay_sai) {
                      <i class="fas fa-check"></i>
                    } @else {
                      <i class="fas fa-times"></i>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }

  </div>
</div>
