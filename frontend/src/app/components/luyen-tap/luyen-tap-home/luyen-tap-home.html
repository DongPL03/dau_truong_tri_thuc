<!-- src/app/components/Practice/luyen-tap-ca-nhan/luyen-tap-ca-nhan.html -->

<div class="page">
  <div class="container">

    <header class="header">
      <div>
        <h1>Luyện tập cá nhân</h1>
        <p class="subtitle">
          Chọn bộ câu hỏi và số lượng câu, sau đó luyện tập giống như trong trận đấu.
        </p>
      </div>
    </header>

    <!-- FORM START -->
    <section class="start-card">
      <form #f="ngForm" (ngSubmit)="onStart(f)">
        <div class="form-row">
          <label>Bộ câu hỏi</label>
          <select
            name="bo_cau_hoi_id"
            [(ngModel)]="bo_cau_hoi_id"
          >
            <option [ngValue]="null">— Chọn bộ câu hỏi —</option>

            @for (bo of bo_cau_hoi_options(); track bo.id) {
              <option [ngValue]="bo.id">
                {{ bo.tieu_de }}
              </option>
            }
          </select>

          @if (loading_sets()) {
            <p class="hint">Đang tải danh sách bộ câu hỏi...</p>
          }
        </div>
        <div class="actions">
          <button class="btn primary" type="submit" [disabled]="loading()">
            {{ loading() ? 'Đang bắt đầu...' : 'Bắt đầu luyện tập' }}
          </button>
          <button
            class="btn secondary"
            type="button"
            (click)="onStartFromMemo()"
            [disabled]="loading() || !bo_cau_hoi_id">
            Luyện tập lại từ thẻ ghi nhớ
          </button>
        </div>
      </form>
    </section>

    <!-- KHU VỰC CHƠI -->

    @if (playing() && currentQuestion(); as q) {
      <section class="practice-area">
        <div class="practice-header">
          <div>
            <h2>{{ practice_data()?.bo_cau_hoi }}</h2>
            <p class="small">
              Câu {{ current_index() + 1 }}/{{ practice_data()?.tong_cau_hoi }}
              – Thời gian còn lại: <strong>{{ remaining_seconds() }}s</strong>
              @if (practice_from_memo()) {
                <span class="badge-memo">Từ thẻ ghi nhớ</span>
              }
            </p>
          </div>
        </div>

        <div class="question-card">

          <div class="question-text">
            {{ q.noi_dung }}
          </div>

          @if (q.duong_dan_tep && q.loai_noi_dung !== 'VAN_BAN') {

            @switch (q.loai_noi_dung) {
              @case ('HINH_ANH') {
                <div class="media">
                  <img
                    [src]="environment.apiBaseUrl + '/cauHoi/media/' + q.duong_dan_tep"
                    alt="Câu hỏi hình ảnh"
                  />
                </div>
              }
              @case ('AM_THANH') {
                <div class="media">
                  <audio
                    controls
                    [src]="environment.apiBaseUrl + '/cauHoi/media/' + q.duong_dan_tep">
                  </audio>
                </div>
              }
              @case ('VIDEO') {
                <div class="media">
                  <video
                    controls
                    [src]="environment.apiBaseUrl + '/cauHoi/media/' + q.duong_dan_tep">
                  </video>
                </div>
              }

            }
          }

          <div class="choices">
            <button
              type="button"
              class="choice"
              [class.active]="currentAnswer() === 'A'"
              (click)="selectAnswer('A')"
            >
              <strong>A.</strong> {{ q.lua_chon_a }}
            </button>

            <button
              type="button"
              class="choice"
              [class.active]="currentAnswer() === 'B'"
              (click)="selectAnswer('B')"
            >
              <strong>B.</strong> {{ q.lua_chon_b }}
            </button>

            <button
              type="button"
              class="choice"
              [class.active]="currentAnswer() === 'C'"
              (click)="selectAnswer('C')"
            >
              <strong>C.</strong> {{ q.lua_chon_c }}
            </button>

            <button
              type="button"
              class="choice"
              [class.active]="currentAnswer() === 'D'"
              (click)="selectAnswer('D')"
            >
              <strong>D.</strong> {{ q.lua_chon_d }}
            </button>
          </div>

          <div class="practice-footer">
            <div class="left">
              <button type="button" (click)="goPrev()" [disabled]="current_index() === 0">
                ← Câu trước
              </button>
            </div>
            <div class="center">
              <span>Câu {{ current_index() + 1 }} / {{ practice_data()?.tong_cau_hoi }}</span>
            </div>
            <div class="right">
              <button type="button" (click)="goNext()"
                      [disabled]="current_index() >= (practice_data()?.tong_cau_hoi || 1) - 1">
                Câu tiếp →
              </button>
            </div>
          </div>

          <div class="submit-row">
            <button
              class="btn primary"
              type="button"
              (click)="submitCurrentQuestion()"
              [disabled]="submitting()"
            >
              {{
                current_index() >= (practice_data()?.tong_cau_hoi || 1) - 1
                  ? (submitting() ? 'Đang nộp & xem kết quả...' : 'Nộp câu cuối & xem kết quả')
                  : 'Nộp câu hiện tại'
              }}
            </button>
          </div>


        </div>
      </section>
    }

    <!-- KẾT QUẢ -->
    @if (finished() && result(); as r) {
      <section class="summary">
        <div class="summary-card">
          <h2>Kết quả luyện tập</h2>
          <p class="summary-main">
            Điểm: <strong>{{ r.diem_so }}</strong> —
            Đúng: <strong>{{ r.so_cau_dung }}/{{ r.tong_so_cau }}</strong> —
            Độ chính xác: <strong>{{ r.do_chinh_xac }}%</strong>
          </p>
          <p class="summary-sub">
            Thời gian trung bình: {{ r.thoi_gian_tb_ms }} ms / câu
          </p>

          <div class="summary-actions">
            <button class="btn" type="button" (click)="current_index.set(0); playing.set(true); finished.set(false)">
              Xem lại câu hỏi
            </button>

          </div>

          <div class="detail-table">
            <h3>Chi tiết từng câu</h3>
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Câu hỏi</th>
                <th>Đáp án chọn</th>
                <th>Đáp án đúng</th>
                <th>Kết quả</th>
                <th>Giải thích</th>
              </tr>
              </thead>
              <tbody>
                @for (d of r.chi_tiet; track $index; let i = $index) {
                  <tr>
                    <td>{{ i + 1 }}</td>

                    <td>{{ practice_data()?.cau_hoi_list?.[i]?.noi_dung }}</td>

                    <!-- Đáp án chọn -->
                    <td [class.correct]="d.dung_hay_sai" [class.wrong]="!d.dung_hay_sai">
                      {{ d.lua_chon || '—' }}
                    </td>

                    <!-- Đáp án đúng -->
                    <td>
                      {{ d.dap_an_dung || '—' }}
                    </td>

                    <!-- Kết quả -->
                    <td><span [class.correct]="d.dung_hay_sai"
                              [class.wrong]="!d.dung_hay_sai">{{ d.dung_hay_sai ? 'Đúng' : 'Sai' }}</span>
                    </td>

                    <!-- Giải thích -->
                    <td class="explain-cell">
                      {{ d.giai_thich || '—' }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </section>
    }
    <!-- ================== LỊCH SỬ LUYỆN TẬP ================== -->
    <section class="history-section">
      <h2>Lịch sử luyện tập gần đây</h2>

      @if (loading_history()) {
        <p>Đang tải lịch sử...</p>
      } @else if (history_items().length === 0) {
        <p>Chưa có phiên luyện tập nào.</p>
      } @else {
        <div class="history-table-wrapper">
          <table class="history-table">
            <thead>
            <tr>
              <th>Thời gian</th>
              <th>Bộ câu hỏi</th>
              <th>Điểm</th>
              <th>Đúng / Tổng</th>
              <th>Độ chính xác</th>
            </tr>
            </thead>
            <tbody>
              @for (h of history_items(); track h.phien_id) {
                <tr>
                  <td>{{ h.ngay_tao | date:'dd/MM/yyyy HH:mm' }}</td>
                  <td>{{ h.bo_cau_hoi }}</td>
                  <td>{{ h.diem_so }}</td>
                  <td>{{ h.so_cau_dung }}/{{ h.tong_cau_hoi }}</td>
                  <td>{{ h.do_chinh_xac }}%</td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!--        <div class="history-pagination">-->
          <!--          <button type="button"-->
          <!--                  (click)="prevHistoryPage()"-->
          <!--                  [disabled]="history_page() === 0">-->
          <!--            Trang trước-->
          <!--          </button>-->
          <!--          <span>-->
          <!--        Trang {{ history_page() + 1 }} / {{ history_total_pages() || 1 }}-->
          <!--      </span>-->
          <!--          <button type="button"-->
          <!--                  (click)="nextHistoryPage()"-->
          <!--                  [disabled]="history_page() >= (history_total_pages() - 1)">-->
          <!--            Trang sau-->
          <!--          </button>-->
          <!--        </div>-->
        @if (totalPagesHistory > 1) {
          <div class="pagination">
            <!-- Nút Previous -->
            <a (click)="changePage(pageHistory - 1)" [class.disabled]="pageHistory === 0">&laquo;</a>

            <!-- Dải trang động -->
            @for (p of getVisiblePages(); track $index) {
              @if (p >= 0) {
                <a [class.active]="p === pageHistory" (click)="changePage(p)">
                  {{ p + 1 }}
                </a>
              } @else {
                <span class="ellipsis">...</span>
              }
            }

            <!-- Nút Next -->
            <a (click)="changePage(pageHistory + 1)"
               [class.disabled]="pageHistory === totalPagesHistory - 1">&raquo;</a>
          </div>
        }
      }
    </section>
    <!-- ================== THẺ GHI NHỚ ================== -->
    <section class="memo-section">
      <h2>Thẻ ghi nhớ</h2>

      @if (loading_memos()) {
        <p>Đang tải thẻ ghi nhớ...</p>
      } @else if (memo_items().length === 0) {
        <p>Chưa có thẻ ghi nhớ nào. Các câu sai trong luyện tập sẽ được tự động thêm vào đây.</p>
      } @else {
        <div class="memo-table-wrapper">
          <table class="memo-table">
            <thead>
            <tr>
              <th>Thời gian</th>
              <th>Bộ câu hỏi</th>
              <th>Câu hỏi</th>
              <th>Đáp án đúng</th>
              <th>Giải thích</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
              @for (m of memo_items(); track m.memo_id) {
                <tr>
                  <td>{{ m.tao_luc | date:'dd/MM/yyyy HH:mm' }}</td>
                  <td>{{ m.bo_cau_hoi }}</td>
                  <td>{{ m.cau_hoi }}</td>
                  <td>{{ m.dap_an_dung }}</td>
                  <td class="explain-cell">
                    <div class="custom-tooltip-wrapper">
                      <div class="truncate-text">
                        {{ m.giai_thich || '—' }}
                      </div>
                      @if (m.giai_thich) {
                        <span class="tooltip-content">{{ m.giai_thich }}</span>
                      }
                    </div>
                  </td>
                  <td class="actions">
                    <button type="button" (click)="practiceSingleFromMemo(m)">
                      Luyện câu này
                    </button>
                    <button type="button" (click)="practiceSetFromMemo(m)">
                      Luyện bộ này
                    </button>
                    <button type="button" (click)="deleteMemoConfirm(m)">
                      Xoá
                    </button>
                  </td>

                </tr>
              }
            </tbody>
          </table>
        </div>

        @if (totalPagesMemo > 1) {
          <div class="pagination">
            <!-- Nút Previous -->
            <a (click)="changePageMemo(pageMemo - 1)" [class.disabled]="pageMemo === 0">&laquo;</a>

            <!-- Dải trang động -->
            @for (p of getVisiblePagesMemo(); track $index) {
              @if (p >= 0) {
                <a [class.active]="p === pageMemo" (click)="changePageMemo(p)">
                  {{ p + 1 }}
                </a>
              } @else {
                <span class="ellipsis">...</span>
              }
            }

            <!-- Nút Next -->
            <a (click)="changePageMemo(pageMemo + 1)" [class.disabled]="pageMemo === totalPagesMemo - 1">&raquo;</a>
          </div>
        }
      }
    </section>


  </div>
</div>
