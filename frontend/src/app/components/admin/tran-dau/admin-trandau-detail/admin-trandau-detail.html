<div class="admin-trandau-detail">

  <button class="btn-back" (click)="goBack()">
    ‚Üê Quay l·∫°i danh s√°ch
  </button>

  <h2>Chi ti·∫øt l·ªãch s·ª≠ tr·∫≠n ƒë·∫•u (Admin)</h2>

  @if (loading) {
    <div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
  } @else {

    @if (detail) {
      <section class="card">
        <h3>Th√¥ng tin tr·∫≠n & ng∆∞·ªùi ch∆°i</h3>
        <div class="info-grid">
          <div>
            <span class="label">ID tr·∫≠n:</span>
            <span>{{ detail.tran_dau_id }}</span>
          </div>
          <div>
            <span class="label">Ph√≤ng:</span>
            <span>{{ detail.ten_phong }} ({{ detail.ma_phong }})</span>
          </div>
          <div>
            <span class="label">B·ªô c√¢u h·ªèi:</span>
            <span>{{ detail.bo_cau_hoi_tieu_de }}</span>
          </div>
          <div>
            <span class="label">Ng∆∞·ªùi ch∆°i:</span>
            <span>{{ detail.ho_ten || detail.username }}</span>
          </div>
          <div>
            <span class="label">Lu·∫≠t t√≠nh ƒëi·ªÉm:</span>
            <span>{{ detail.luat_tinh_diem }}</span>
          </div>
          <div>
            <span class="label">Th·ªùi gian:</span>
            <span>
              {{ detail.bat_dau_luc | date:'dd/MM/yyyy HH:mm' }} -
              {{ detail.ket_thuc_luc | date:'dd/MM/yyyy HH:mm' }}
            </span>
          </div>
          <div>
            <span class="label">ƒêi·ªÉm / c√¢u ƒë√∫ng:</span>
            <span>{{ detail.tong_diem }} ƒëi·ªÉm, {{ detail.so_cau_dung }} c√¢u ƒë√∫ng</span>
          </div>
          <div>
            <span class="label">Th·ªùi gian tr·∫£ l·ªùi:</span>
            <span>{{ (detail.tong_thoi_gian_ms / 1000) | number:'1.0-1' }} gi√¢y</span>
          </div>
          <div>
            <span class="label">X·∫øp h·∫°ng:</span>
            <span>{{ detail.xep_hang }}</span>
          </div>
        </div>
      </section>
    }

    @if (leaderboard.length > 0) {
      <section class="card">
        <h3>B·∫£ng x·∫øp h·∫°ng tr·∫≠n ƒë·∫•u</h3>
        <table class="table">
          <thead>
          <tr>
            <th>H·∫°ng</th>
            <th>Ng∆∞·ªùi ch∆°i</th>
            <th>ƒêi·ªÉm</th>
            <th>C√¢u ƒë√∫ng</th>
          </tr>
          </thead>
          <tbody>
            @for (p of leaderboard; track $index) {
              <tr (click)="openPlayerModal(p)" class="click-row">
                <td>{{ p.xepHang || p.xep_hang }}</td>
                <td>{{ p.hoTen || p.ho_ten }}</td>
                <td>{{ p.diem }}</td>
                <td>{{ p.soCauDung || p.so_cau_dung }}</td>
              </tr>
            }
          </tbody>
        </table>
      </section>
    }

    @if (questions.length > 0) {
      <section class="card">
        <h3>Chi ti·∫øt c√¢u h·ªèi & ƒë√°p √°n</h3>

        <table class="table">
          <thead>
          <tr>
            <th>#</th>
            <th>N·ªôi dung</th>
            <th>ƒê√°p √°n ƒë√∫ng</th>
            <th>ƒê√°p √°n ng∆∞·ªùi ch∆°i</th>
            <th>K·∫øt qu·∫£</th>
            <th>Th·ªùi gian (ms)</th>
          </tr>
          </thead>
          <tbody>
            @for (q of questions; track $index; let i = $index) {
              <tr (click)="openQuestionModal(q)" class="click-row">
                <td>{{ i + 1 }}</td>
                <td>{{ q.noi_dung }}</td>
                <td>{{ q.dap_an_dung }}</td>
                <td>{{ q.nguoi_dung_chon }}</td>
                <td>
                  <span [ngClass]="q.dung_hay_sai ? 'badge-win' : 'badge-lose'">
                    {{ q.dung_hay_sai ? 'ƒê√∫ng' : 'Sai' }}
                  </span>
                </td>
                <td>{{ q.thoi_gian_ms }}</td>
              </tr>
            }
          </tbody>
        </table>
      </section>
    }

    @if (detail) {
      <section class="card">
        <h3>D·ªØ li·ªáu ƒë·∫ßy ƒë·ªß (debug)</h3>
        <pre>{{ detail | json }}</pre>
      </section>
    }

  }

  @if (show_player_modal) {
    <div class="modal-backdrop" (click)="closePlayerModal()">
      <div class="admin-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Chi ti·∫øt c√¢u h·ªèi c·ªßa ng∆∞·ªùi ch∆°i</h3>
          <button (click)="closePlayerModal()">‚úï</button>
        </div>

        <div class="modal-subtitle">
          {{ player_modal_title }}
        </div>

        @if (player_modal_loading) {
          <div class="loading">ƒêang t·∫£i...</div>
        } @else {
          @if (player_answers.length > 0) {
            <table class="table">
              <thead>
              <tr>
                <th>#</th>
                <th>N·ªôi dung</th>
                <th>ƒê√°p √°n ƒë√∫ng</th>
                <th>ƒê√°p √°n ng∆∞·ªùi ch∆°i</th>
                <th>K·∫øt qu·∫£</th>
                <th>Th·ªùi gian (ms)</th>
              </tr>
              </thead>
              <tbody>
                @for (q of player_answers; track $index; let i = $index) {
                  <tr>
                    <td>{{ i + 1 }}</td>
                    <td>{{ q.noi_dung }}</td>
                    <td>{{ q.dap_an_dung }}</td>
                    <td>{{ q.nguoi_dung_chon }}</td>
                    <td>
                      <span [ngClass]="q.dung_hay_sai ? 'badge-win' : 'badge-lose'">
                        {{ q.dung_hay_sai ? 'ƒê√∫ng' : 'Sai' }}
                      </span>
                    </td>
                    <td>{{ q.thoi_gian_ms }}</td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div>Kh√¥ng c√≥ d·ªØ li·ªáu.</div>
          }
        }
      </div>
    </div>
  }

  @if (show_question_modal) {
    <div class="modal-backdrop" (click)="closeQuestionModal()">
      <div class="admin-modal admin-modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Chi ti·∫øt c√¢u h·ªèi</h3>
          <button (click)="closeQuestionModal()">‚úï</button>
        </div>

        @if (question_modal_loading) {
          <div class="loading">ƒêang t·∫£i...</div>
        } @else {
          @if (question_modal) {
            <div class="question-info">

              @if (question_modal.loai_noi_dung === 'HINH_ANH' && question_modal.duong_dan_tep) {
                <div class="media-cinematic"
                     [style.backgroundImage]="'url(http://localhost:8088/api/v1/cauHoi/media/' + question_modal.duong_dan_tep + ')'">
                  <div class="overlay"></div>
                  <img [src]="'http://localhost:8088/api/v1/cauHoi/media/' + question_modal.duong_dan_tep"
                       alt="Question Image">
                </div>
              }

              @if (question_modal.loai_noi_dung === 'AM_THANH' && question_modal.duong_dan_tep) {
                <div class="media-audio-box">
                  <div class="icon-disk">üíø</div>
                  <audio controls>
                    <source [src]="'http://localhost:8088/api/v1/cauHoi/media/' + question_modal.duong_dan_tep"
                            type="audio/mpeg">
                  </audio>
                </div>
              }

              <div class="info-content">
                <div class="question-text">
                  <span class="badge-type">{{ question_modal.loai_noi_dung }}</span>
                  <strong>{{ question_modal.noi_dung }}</strong>
                </div>

                <ul class="choices">
                  <li [class.is-correct]="question_modal.dap_an_dung === 'A'">
                    <strong>A.</strong> {{ question_modal.lua_chon_a }}
                  </li>
                  <li [class.is-correct]="question_modal.dap_an_dung === 'B'">
                    <strong>B.</strong> {{ question_modal.lua_chon_b }}
                  </li>
                  <li [class.is-correct]="question_modal.dap_an_dung === 'C'">
                    <strong>C.</strong> {{ question_modal.lua_chon_c }}
                  </li>
                  <li [class.is-correct]="question_modal.dap_an_dung === 'D'">
                    <strong>D.</strong> {{ question_modal.lua_chon_d }}
                  </li>
                </ul>

                <div class="correct-text">
                  ƒê√°p √°n ƒë√∫ng: <strong>{{ question_modal.dap_an_dung }}</strong>
                </div>
              </div>
            </div>

            <table class="table">
              <thead>
              <tr>
                <th>Ng∆∞·ªùi ch∆°i</th>
                <th>L·ª±a ch·ªçn</th>
                <th>K·∫øt qu·∫£</th>
                <th>Th·ªùi gian (ms)</th>
              </tr>
              </thead>
              <tbody>
                @for (row of question_modal.nguoi_choi; track $index) {
                  <tr>
                    <td>{{ row.ho_ten }}</td>
                    <td>{{ row.lua_chon }}</td>
                    <td>
                      <span [ngClass]="row.dung_hay_sai ? 'badge-win' : 'badge-lose'">
                        {{ row.dung_hay_sai ? 'ƒê√∫ng' : 'Sai' }}
                      </span>
                    </td>
                    <td>{{ row.thoi_gian_ms }}</td>
                  </tr>
                }
              </tbody>
            </table>
          }
        }
      </div>
    </div>
  }

</div>
