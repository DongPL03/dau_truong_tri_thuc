@if (!loading()) {
  <div class="page">
    <div class="container">
      <header class="header">
        <div class="title">
          <h1>{{ pageTitle() }}</h1>
          <span class="code">#{{ battle()?.ma_phong }}</span>
          <span [class]="badgeClass(status())">{{ status() }}</span>
        </div>
        <div class="meta">
          <div>
            <strong>Ch·∫ø ƒë·ªô:</strong>
            <span>{{ battle()?.cong_khai ? 'C√¥ng khai' : 'Ri√™ng t∆∞' }}</span>

            @if (!battle()?.cong_khai) {
              ‚Äî <em>Y√™u c·∫ßu PIN</em>
            }
          </div>
          <div>
            <strong>B·ªô c√¢u h·ªèi:</strong>
            {{ battle()?.bo_cau_hoi_tieu_de || ('#' + battle()?.bo_cau_hoi_id) }}
          </div>
          <div>
            <strong>Gi·ªõi h·∫°n ng∆∞·ªùi ch∆°i:</strong> {{ battle()?.gioi_han_nguoi_choi }}
          </div>
          <div>
            <strong>Th·ªùi gian m·ªói c√¢u:</strong>
            {{ battle()?.gioi_han_thoi_gian_cau_giay }} gi√¢y ‚Äî
            <strong>Lu·∫≠t ƒëi·ªÉm:</strong> {{ battle()?.luat_tinh_diem }}
          </div>
        </div>
      </header>

      <section class="actions">
        <div class="left">
          <button class="btn" (click)="doSync()" [disabled]="saving()">ƒê·ªìng b·ªô</button>
          @if (battle()?.chu_phong_ten === currentUserName()) {
            <button class="btn primary" (click)="startBattle()" [disabled]="!isPending() || saving()">B·∫Øt ƒë·∫ßu</button>
            <button class="btn warn" (click)="finishBattle()" [disabled]="!isOngoing() || saving()">K·∫øt th√∫c</button>
          }
          <button class="btn ghost" (click)="leave()" [disabled]="saving()">R·ªùi ph√≤ng</button>
        </div>

        @if (!battle()?.cong_khai && isPending()) {
          <div class="right">
            <input
              class="pin"
              placeholder="Nh·∫≠p PIN"
              [ngModel]="pinCode()"
              (ngModelChange)="pinCode.set($event)"
            />
            <button class="btn" (click)="join()" [disabled]="saving() || !pinCode()">Tham gia</button>
          </div>
        } @else if (battle()?.cong_khai && isPending()) {
          <div class="right">
            <button class="btn" (click)="join()" [disabled]="saving()">Tham gia</button>
          </div>
        }
      </section>

      <!-- ================== OVERLAY COUNTDOWN CHU·∫®N B·ªä (N·∫æU C√ì) ================== -->
      @if (preCountdown() > 0 && !showSummary()) {
        <div class="pre-countdown-overlay">
          <div class="pre-countdown-card">
            <div class="label">Tr·∫≠n ƒë·∫•u s·∫Øp b·∫Øt ƒë·∫ßu</div>
            <div class="number">{{ preCountdown() }}</div>
            <p>H√£y s·∫µn s√†ng cho c√¢u h·ªèi ƒë·∫ßu ti√™n!</p>
          </div>
        </div>
      }

      <!-- ================== N·∫æU ƒê√É K·∫æT TH√öC: M√ÄN H√åNH SUMMARY ================== -->
      <!--      @if (showSummary()) {-->

      <!--        <section class="summary-wrapper">-->
      <!--          <div class="summary-left">-->
      <!--            <div class="summary-header-card">-->
      <!--              <h2>Tr·∫≠n ƒë·∫•u ƒë√£ k·∫øt th√∫c üéâ</h2>-->
      <!--              <p>Ph√≤ng: <strong>{{ battle()?.ten_phong }}</strong> (M√£: {{ battle()?.ma_phong }})</p>-->
      <!--              <p>-->
      <!--                B·∫Øt ƒë·∫ßu:-->
      <!--                <strong>{{ battle()?.bat_dau_luc | date:'HH:mm:ss dd/MM/yyyy' }}</strong>-->
      <!--                ¬∑ K·∫øt th√∫c:-->
      <!--                <strong>{{ battle()?.ket_thuc_luc | date:'HH:mm:ss dd/MM/yyyy' }}</strong>-->
      <!--              </p>-->
      <!--            </div>-->

      <!--            @if (summary_winner; as w) {-->
      <!--              <div class="winner-card">-->
      <!--                <div class="winner-badge">üèÜ Qu√°n qu√¢n</div>-->
      <!--                <div class="winner-name">{{ w.ho_ten }}</div>-->
      <!--                <div class="winner-meta">-->
      <!--                  <span>ƒêi·ªÉm: <strong>{{ w.diem }}</strong></span>-->
      <!--                  <span>S·ªë c√¢u ƒë√∫ng: <strong>{{ w.so_cau_dung }}</strong></span>-->
      <!--                </div>-->
      <!--              </div>-->
      <!--            }-->

      <!--            <div class="summary-actions">-->
      <!--              <button class="btn primary" (click)="router.navigateByUrl('/battle/room-list')">-->
      <!--                V·ªÅ danh s√°ch ph√≤ng-->
      <!--              </button>-->
      <!--              <button class="btn" (click)="router.navigateByUrl('/home')">-->
      <!--                V·ªÅ trang ch·ªß-->
      <!--              </button>-->
      <!--            </div>-->
      <!--          </div>-->

      <!--          <div class="summary-right">-->
      <!--            <h3>B·∫£ng x·∫øp h·∫°ng</h3>-->

      <!--            @if (summary_leaderboard.length > 0) {-->
      <!--              <table class="leaderboard-table">-->
      <!--                <thead>-->
      <!--                <tr>-->
      <!--                  <th>H·∫°ng</th>-->
      <!--                  <th>Ng∆∞·ªùi ch∆°i</th>-->
      <!--                  <th>ƒêi·ªÉm</th>-->
      <!--                  <th>S·ªë c√¢u ƒë√∫ng</th>-->
      <!--                </tr>-->
      <!--                </thead>-->
      <!--                <tbody>-->
      <!--                  @for (p of summary_leaderboard; track p.user_id) {-->
      <!--                    <tr-->
      <!--                      [class.is-me]="is_my_row(p)"-->
      <!--                      [class.is-winner]="is_winner_row(p)"-->
      <!--                    >-->
      <!--                      <td>-->
      <!--                      <span class="rank-chip">-->
      <!--                        {{ p.xep_hang }}-->
      <!--                        @if (p.xep_hang === 1) { ü•á }-->
      <!--                        @if (p.xep_hang === 2) { ü•à }-->
      <!--                        @if (p.xep_hang === 3) { ü•â }-->
      <!--                      </span>-->
      <!--                      </td>-->
      <!--                      <td>{{ p.ho_ten }}</td>-->
      <!--                      <td>{{ p.diem }}</td>-->
      <!--                      <td>{{ p.so_cau_dung }}</td>-->
      <!--                    </tr>-->
      <!--                  }-->
      <!--                </tbody>-->
      <!--              </table>-->
      <!--            } @else {-->
      <!--              <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng.</p>-->
      <!--            }-->
      <!--          </div>-->
      <!--        </section>-->

      <!--      } @else {-->

      <!--        &lt;!&ndash; ================== PH·∫¶N THI ƒê·∫§U ================== &ndash;&gt;-->
      <!--        @if (syncState(); as s) {-->
      <!--          <section class="play">-->
      <!--            <h3>Tr·∫°ng th√°i hi·ªán t·∫°i</h3>-->
      <!--            <div class="grid">-->
      <!--              <div class="cell">-->
      <!--                <div class="label">C√¢u hi·ªán t·∫°i</div>-->
      <!--                <div class="value">{{ s.current_question_index >= 0 ? s.current_question_index + 1 : '‚Äî' }}</div>-->
      <!--              </div>-->
      <!--              <div class="cell">-->
      <!--                <div class="label">ƒêi·ªÉm c·ªßa b·∫°n</div>-->
      <!--                <div class="value highlight">{{ s.my_total_points }}</div>-->
      <!--              </div>-->
      <!--              <div class="cell">-->
      <!--                <div class="label">ƒê·∫øm ng∆∞·ª£c</div>-->
      <!--                <div class="value countdown">-->
      <!--                  {{ remainingSeconds() > 0 ? remainingSeconds() + 's' : '0s' }}-->
      <!--                </div>-->
      <!--              </div>-->
      <!--            </div>-->

      <!--            @if (s.current_question_index >= 0) {-->
      <!--              <div class="question-block" [attr.data-question-id]="s.current_question_id"-->
      <!--                   [attr.data-version]="s._version">-->
      <!--                <div class="question">{{ s.noi_dung }}</div>-->

      <!--                &lt;!&ndash; üîπ MEDIA ƒêA N·ªòI DUNG &ndash;&gt;-->
      <!--                @if (s.duong_dan_tep && s.loai_noi_dung !== 'VAN_BAN') {-->

      <!--                  @switch (s.loai_noi_dung) {-->

      <!--                    @case ('HINH_ANH') {-->
      <!--                      <div class="media" [attr.data-unique]="s.current_question_id + '-' + s._version">-->
      <!--                        <img-->
      <!--                          [src]="environment.apiBaseUrl + '/cauHoi/media/' + s.duong_dan_tep + '?v=' + s._version"-->
      <!--                          alt="C√¢u h·ªèi h√¨nh ·∫£nh"-->
      <!--                          (load)="console.log('·∫¢nh loaded:', s.duong_dan_tep)"-->
      <!--                        />-->
      <!--                      </div>-->
      <!--                    }-->
      <!--                    @case ('AM_THANH') {-->
      <!--                      <div class="media" [attr.data-unique]="s.current_question_id + '-' + s._version">-->
      <!--                        <audio-->
      <!--                          controls-->
      <!--                          [src]="environment.apiBaseUrl + '/cauHoi/media/' + s.duong_dan_tep + '?v=' + s._version"-->
      <!--                          (loadeddata)="console.log('√Çm thanh loaded:', s.duong_dan_tep)"-->
      <!--                        ></audio>-->
      <!--                      </div>-->
      <!--                    }-->
      <!--                    @case ('VIDEO') {-->
      <!--                      <div class="media" [attr.data-unique]="s.current_question_id + '-' + s._version">-->
      <!--                        <video-->
      <!--                          controls-->
      <!--                          [src]="environment.apiBaseUrl + '/cauHoi/media/' + s.duong_dan_tep + '?v=' + s._version"-->
      <!--                          (loadeddata)="console.log('Video loaded:', s.duong_dan_tep)"-->
      <!--                        ></video>-->
      <!--                      </div>-->
      <!--                    }-->
      <!--                  }-->
      <!--                }-->

      <!--                <div class="choices">-->
      <!--                  @for (opt of ['A', 'B', 'C', 'D']; track $index) {-->
      <!--                    <button-->
      <!--                      class="choice"-->
      <!--                      [class.active]="selectedAnswer() === opt"-->
      <!--                      (click)="selectAnswer(opt)"-->
      <!--                      [disabled]="saving()"-->
      <!--                    >-->
      <!--                      <strong>{{ opt }}.</strong>-->
      <!--                      {{-->
      <!--                        opt === 'A' ? s.a :-->
      <!--                          opt === 'B' ? s.b :-->
      <!--                            opt === 'C' ? s.c :-->
      <!--                              opt === 'D' ? s.d : ''-->
      <!--                      }}-->
      <!--                    </button>-->
      <!--                  }-->
      <!--                </div>-->
      <!--                <div class="submit-row">-->
      <!--                  <button class="btn primary" (click)="submitSelectedAnswer()" [disabled]="saving()">N·ªôp ƒë√°p √°n</button>-->
      <!--                </div>-->
      <!--              </div>-->
      <!--            } @else {-->
      <!--              <div class="hint">Ch∆∞a c√≥ c√¢u h·ªèi ƒëang b·∫≠t. H√£y ch·ªù ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu.</div>-->
      <!--            }-->
      <!--          </section>-->
      <!--        }-->

      <!--        &lt;!&ndash; ================== B·∫¢NG X·∫æP H·∫†NG MINI ================== &ndash;&gt;-->
      <!--        @if (leaderboard().length > 0) {-->
      <!--          <section class="leaderboard">-->
      <!--            <h3>B·∫£ng x·∫øp h·∫°ng</h3>-->
      <!--            <table class="ranking">-->
      <!--              <thead>-->
      <!--              <tr>-->
      <!--                <th>H·∫°ng</th>-->
      <!--                <th>Ng∆∞·ªùi ch∆°i</th>-->
      <!--                <th>ƒêi·ªÉm</th>-->
      <!--                <th>ƒê√∫ng</th>-->
      <!--              </tr>-->
      <!--              </thead>-->
      <!--              <tbody>-->
      <!--                @for (p of leaderboard(); track p.user_id) {-->
      <!--                  <tr>-->
      <!--                    <td>{{ p.xep_hang }}</td>-->
      <!--                    <td>{{ p.ho_ten }}</td>-->
      <!--                    <td>{{ p.diem }}</td>-->
      <!--                    <td>{{ p.so_cau_dung }}</td>-->
      <!--                  </tr>-->
      <!--                } @empty {-->
      <!--                  <tr>-->
      <!--                    <td colspan="4">Kh√¥ng c√≥ ng∆∞·ªùi ch∆°i n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</td>-->
      <!--                  </tr>-->
      <!--                }-->
      <!--              </tbody>-->
      <!--            </table>-->
      <!--          </section>-->
      <!--        }-->

      <!--      } &lt;!&ndash; end @else showSummary &ndash;&gt;-->
      @if (showSummary()) {
        <!-- ================== M√ÄN H√åNH K·∫æT QU·∫¢ TR·∫¨N ƒê·∫§U ================== -->
        <section class="summary-wrapper">
          <!-- C·ªôt tr√°i: banner + b·∫£ng x·∫øp h·∫°ng -->
          <div class="summary-left">
            <!-- Banner k·∫øt qu·∫£ -->
            <div class="summary-header-card">
              <h2>
                {{ battle()?.bo_cau_hoi_tieu_de || 'B·ªô Quiz' }}
              </h2>
              <p>
                Tr·∫°ng th√°i:
                <strong>{{ isWinnerMe ? 'CHI·∫æN TH·∫ÆNG! üëë' : 'Tr·∫≠n ƒë·∫•u ƒë√£ k·∫øt th√∫c' }}</strong>
              </p>

              @if (mySummaryRow) {
                <div class="winner-card" [class.is-me]="isWinnerMe">
                  <div class="winner-badge">
                    {{ isWinnerMe ? 'B·∫°n l√† Qu√°n qu√¢n' : 'Th√†nh t√≠ch c·ªßa b·∫°n' }}
                  </div>
                  <div class="winner-name">
                    {{ mySummaryRow.ho_ten }}
                  </div>
                  <div class="winner-meta">
                    <span>X·∫øp h·∫°ng cu·ªëi c√πng: <strong>#{{ mySummaryRow.xep_hang }}</strong></span>
                    <span>T·ªïng ƒëi·ªÉm: <strong>{{ mySummaryRow.diem }}</strong></span>
                    <span>S·ªë c√¢u ƒë√∫ng: <strong>{{ mySummaryRow.so_cau_dung }}</strong></span>
                  </div>
                </div>
              }
            </div>

            <!-- B·∫£ng x·∫øp h·∫°ng chung cu·ªôc -->
            <section class="leaderboard">
              <h3>B·∫£ng x·∫øp h·∫°ng chung cu·ªôc</h3>
              <table class="leaderboard-table">
                <thead>
                <tr>
                  <th>H·∫°ng</th>
                  <th>Ng∆∞·ªùi ch∆°i</th>
                  <th>T·ªïng ƒëi·ªÉm</th>
                  <th>ƒê√∫ng</th>
                </tr>
                </thead>
                <tbody>
                  @for (p of finalResult?.leaderboard || []; track p.user_id) {
                    <tr
                      [class.is-me]="p.user_id === finalResult?.myId"
                      [class.is-winner]="p.user_id === finalResult?.winner?.user_id"
                    >
                      <td>
                       <span class="rank-chip">
                         {{ p.xep_hang }}
                         @if (p.xep_hang === 1) {
                           ü•á
                         }
                         @if (p.xep_hang === 2) {
                           ü•à
                         }
                         @if (p.xep_hang === 3) {
                           ü•â
                         }
                       </span>
                      </td>
                      <td>{{ p.ho_ten }}</td>
                      <td>{{ p.diem }}</td>
                      <td>{{ p.so_cau_dung }}</td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="4">Kh√¥ng c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng.</td>
                    </tr>
                  }
                </tbody>
              </table>
            </section>
          </div>

          <!-- C·ªôt ph·∫£i: h√†nh ƒë·ªông -->
          <div class="summary-right">
            <h3>H√†nh ƒë·ªông</h3>
            <div class="summary-actions">
              <button class="btn primary" (click)="goBackToBattleList()">
                Xem danh s√°ch ph√≤ng
              </button>
              <button class="btn" (click)="goBackHome()">
                V·ªÅ trang ch·ªß
              </button>
              <button class="btn warn" (click)="practiceThisSet()">
                Luy·ªán t·∫≠p l·∫°i b·ªô n√†y
              </button>
            </div>
          </div>
        </section>
      } @else {
        <!-- ================== PH·∫¶N THI ƒê·∫§U ================== -->
        @if (syncState(); as s) {
          <section class="play">
            <h3>Tr·∫°ng th√°i hi·ªán t·∫°i</h3>
            <div class="grid">
              <div class="cell">
                <div class="label">C√¢u hi·ªán t·∫°i</div>
                <div class="value">{{ s.current_question_index >= 0 ? s.current_question_index + 1 : '‚Äî' }}</div>
              </div>
              <div class="cell">
                <div class="label">ƒêi·ªÉm c·ªßa b·∫°n</div>
                <div class="value highlight">{{ s.my_total_points }}</div>
              </div>
              <div class="cell">
                <div class="label">ƒê·∫øm ng∆∞·ª£c</div>
                <div class="value countdown">
                  {{ remainingSeconds() > 0 ? remainingSeconds() + 's' : '0s' }}
                </div>
              </div>
            </div>

            @if (s.current_question_index >= 0) {
              <div class="question-block" [attr.data-question-id]="s.current_question_id"
                   [attr.data-version]="s._version">
                <div class="question">{{ s.noi_dung }}</div>

                <!-- MEDIA -->
                @if (s.duong_dan_tep && s.loai_noi_dung !== 'VAN_BAN') {
                  @switch (s.loai_noi_dung) {
                    @case ('HINH_ANH') {
                      <div class="media" [attr.data-unique]="s.current_question_id + '-' + s._version">
                        <img
                          [src]="environment.apiBaseUrl + '/cauHoi/media/' + s.duong_dan_tep + '?v=' + s._version"
                          alt="C√¢u h·ªèi h√¨nh ·∫£nh"
                          (load)="console.log('·∫¢nh loaded:', s.duong_dan_tep)"
                        />
                      </div>
                    }
                    @case ('AM_THANH') {
                      <div class="media" [attr.data-unique]="s.current_question_id + '-' + s._version">
                        <audio
                          controls
                          [src]="environment.apiBaseUrl + '/cauHoi/media/' + s.duong_dan_tep + '?v=' + s._version"
                          (loadeddata)="console.log('√Çm thanh loaded:', s.duong_dan_tep)"
                        ></audio>
                      </div>
                    }
                    @case ('VIDEO') {
                      <div class="media" [attr.data-unique]="s.current_question_id + '-' + s._version">
                        <video
                          controls
                          [src]="environment.apiBaseUrl + '/cauHoi/media/' + s.duong_dan_tep + '?v=' + s._version"
                          (loadeddata)="console.log('Video loaded:', s.duong_dan_tep)"
                        ></video>
                      </div>
                    }
                  }
                }

                <div class="choices">
                  @for (opt of ['A', 'B', 'C', 'D']; track $index) {
                    <button
                      class="choice"
                      [class.active]="selectedAnswer() === opt"
                      (click)="selectAnswer(opt)"
                      [disabled]="saving() || submittedCurrentAnswer() || remainingSeconds() <= 0"
                    >
                      <strong>{{ opt }}.</strong>
                      {{
                        opt === 'A' ? s.a :
                          opt === 'B' ? s.b :
                            opt === 'C' ? s.c :
                              opt === 'D' ? s.d : ''
                      }}
                    </button>
                  }
                </div>

                @if (submittedCurrentAnswer()) {
                  <div class="hint">
                    B·∫°n ƒë√£ n·ªôp ƒë√°p √°n. H√£y ch·ªù c√¢u h·ªèi ti·∫øp theo nh√©.
                  </div>
                }

                <div class="submit-row">
                  <button
                    class="btn primary"
                    (click)="submitSelectedAnswer()"
                    [disabled]="saving() || submittedCurrentAnswer()"
                  >
                    N·ªôp ƒë√°p √°n
                  </button>
                </div>
              </div>
            } @else {
              <div class="hint">Ch∆∞a c√≥ c√¢u h·ªèi ƒëang b·∫≠t. H√£y ch·ªù ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu.</div>
            }
          </section>
        }

        <!-- ================== B·∫¢NG X·∫æP H·∫†NG MINI ================== -->
        @if (leaderboard().length > 0) {
          <section class="leaderboard">
            <h3>B·∫£ng x·∫øp h·∫°ng</h3>
            <table class="ranking">
              <thead>
              <tr>
                <th>H·∫°ng</th>
                <th>Ng∆∞·ªùi ch∆°i</th>
                <th>ƒêi·ªÉm</th>
                <th>ƒê√∫ng</th>
              </tr>
              </thead>
              <tbody>
                @for (p of leaderboard(); track p.user_id) {
                  <tr>
                    <td>{{ p.xep_hang }}</td>
                    <td>{{ p.ho_ten }}</td>
                    <td>{{ p.diem }}</td>
                    <td>{{ p.so_cau_dung }}</td>
                  </tr>
                } @empty {
                  <tr>
                    <td colspan="4">Kh√¥ng c√≥ ng∆∞·ªùi ch∆°i n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</td>
                  </tr>
                }
              </tbody>
            </table>
          </section>
        }
      }

    </div>
  </div>
} @else {
  <div class="loading">
    <i class="fas fa-spinner fa-spin"></i>
    ƒêang t·∫£i ph√≤ng...
  </div>
}
