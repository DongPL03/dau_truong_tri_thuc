<div class="history-page">
  <div class="history-container">

    <header class="page-header animate-fade-down">
      <div class="header-info">
        <h1>üìú L·ªãch s·ª≠ ƒë·∫•u tr∆∞·ªùng</h1>
        <p>Theo d√µi h√†nh tr√¨nh leo rank v√† th√†nh t√≠ch c·ªßa b·∫°n</p>
      </div>
    </header>

    <div class="toolbar animate-fade-up">
      <div class="search-group">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="T√¨m theo t√™n ph√≤ng ho·∫∑c b·ªô c√¢u h·ªèi..."
               [ngModel]="searchQuery" (ngModelChange)="onSearch($event)">
      </div>

      <div class="filter-group">
        <select [(ngModel)]="filterRank" (change)="onFilterChange()">
          <option value="all">T·∫•t c·∫£ th·ª© h·∫°ng</option>
          <option value="1">üèÜ Top 1 (Victory)</option>
          <option value="top3">üèÖ Top 3</option>
        </select>

        <select [(ngModel)]="filterTime" (change)="onFilterChange()">
          <option value="all">To√†n th·ªùi gian</option>
          <option value="7days">7 ng√†y qua</option>
          <option value="30days">30 ng√†y qua</option>
        </select>
      </div>
    </div>

    <div class="table-card animate-fade-up">

      @if (loading) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
      } @else {

        @if (items.length === 0) {
          <div class="empty-state">
            <img src="assets/images/empty-history.png" alt="Empty" onerror="this.style.display='none'">
            <p>Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫•u n√†o. <a routerLink="/tran-dau">Chi·∫øn ngay!</a></p>
          </div>
        } @else {
          <div class="table-responsive">
            <table class="modern-table">
              <thead>
              <tr>
                <th class="col-time">Th·ªùi gian</th>
                <th class="col-info">Th√¥ng tin tr·∫≠n ƒë·∫•u</th>
                <th class="col-stat text-center">ƒê√∫ng</th>
                <th class="col-stat text-center">ƒêi·ªÉm</th>
                <th class="col-rank text-center">H·∫°ng</th>
                <th class="col-action"></th>
              </tr>
              </thead>
              <tbody>
                @for (h of items; track h.lich_su_id) {
                  <tr [class.highlight]="h.xep_hang === 1" (click)="goToBattleDetail(h.tran_dau_id)">

                    <td class="col-time">
                      <div class="date-box">
                        <span class="day">{{ h.hoan_thanh_luc | date:'dd/MM' }}</span>
                        <span class="time">{{ h.hoan_thanh_luc | date:'HH:mm' }}</span>
                      </div>
                    </td>

                    <td class="col-info">
                      <div class="match-info">
                        <span class="room-name">{{ h.ten_phong || ('Ph√≤ng #' + h.tran_dau_id) }}</span>
                        <span class="quiz-name"><i
                          class="fas fa-book-open"></i> {{ h.bo_cau_hoi_tieu_de || 'Kh√¥ng x√°c ƒë·ªãnh' }}</span>
                        <span class="mode-badge">{{ h.luat_tinh_diem }}</span>
                      </div>
                    </td>

                    <td class="col-stat text-center">
                      <span class="stat-val correct">{{ h.so_cau_dung }}</span>
                    </td>

                    <td class="col-stat text-center">
                      <span class="stat-val score">+{{ h.tong_diem | number }}</span>
                    </td>

                    <td class="col-rank text-center">
                      @if (h.xep_hang === 1) {
                        <span class="rank-badge rank-1"><i class="fas fa-crown"></i> #1</span>
                      } @else if (h.xep_hang === 2) {
                        <span class="rank-badge rank-2">#2</span>
                      } @else if (h.xep_hang === 3) {
                        <span class="rank-badge rank-3">#3</span>
                      } @else {
                        <span class="rank-badge rank-other">#{{ h.xep_hang }}</span>
                      }
                    </td>

                    <td class="col-action text-right">
                      <button class="btn-icon" title="Xem chi ti·∫øt">
                        <i class="fas fa-chevron-right"></i>
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          @if (total_pages > 1) {
            <div class="pagination-container">
              <button class="page-btn" [disabled]="page === 0" (click)="changePage(page - 1)">
                <i class="fas fa-chevron-left"></i>
              </button>

              <div class="page-numbers">
                @for (p of getVisiblePages(); track $index) {
                  @if (p >= 0) {
                    <button class="num-btn" [class.active]="p === page" (click)="changePage(p)">{{ p + 1 }}</button>
                  } @else {
                    <span class="dots">...</span>
                  }
                }
              </div>

              <button class="page-btn" [disabled]="page === total_pages - 1" (click)="changePage(page + 1)">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          }
        }
      }
    </div>
  </div>
</div>
