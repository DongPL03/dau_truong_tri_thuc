@if (!loading) {
  <div class="inventory-container">

    <header class="inventory-header">
      <div class="header-content">
        <h1>üéí Kho T√†ng Tri Th·ª©c</h1>
        <p>Qu·∫£n l√Ω c√°c b·ªô c√¢u h·ªèi, luy·ªán t·∫≠p v√† chia s·∫ª ki·∫øn th·ª©c.</p>
      </div>
      <button class="btn-hero-3d" (click)="goToCreateQuiz()">
        <span class="btn-icon"><i class="fas fa-plus"></i></span>
        <span class="btn-text">T·∫°o B·ªô C√¢u H·ªèi M·ªõi</span>
      </button>
    </header>

    <div class="inventory-layout">

      <aside class="control-panel">
        <div class="panel-header">
          <i class="fas fa-sliders-h"></i> B·ªô L·ªçc
        </div>

        <div class="filter-group">
          <div class="search-hud">
            <i class="fas fa-search"></i>
            <input [(ngModel)]="keyword" (keyup.enter)="applyFilter()"
                   placeholder="T√¨m ki·∫øm b·ªô c√¢u h·ªèi..."/>
          </div>
        </div>

        <div class="filter-group">
          <label class="group-label">S·∫Øp x·∫øp</label>
          <div class="select-wrapper">
            <select [(ngModel)]="sortOrder" class="custom-select">
              <option value="NEWEST">üïê M·ªõi nh·∫•t</option>
              <option value="OLDEST">üìÖ C≈© nh·∫•t</option>
              <option value="RATING_DESC">‚≠ê ƒê√°nh gi√° cao nh·∫•t</option>
              <option value="RATING_ASC">‚≠ê ƒê√°nh gi√° th·∫•p nh·∫•t</option>
            </select>
            <i class="fas fa-chevron-down arrow"></i>
          </div>
        </div>

        <div class="filter-group">
          <label class="group-label">Ch·∫ø ƒë·ªô</label>
          <div class="toggle-col">
            <label class="radio-card"
                   [class.active]="cheDoHienThi === ''">
              <input type="radio" name="vis" value=""
                     [(ngModel)]="cheDoHienThi" hidden>
              <i class="fas fa-layer-group"></i> T·∫•t c·∫£
            </label>
            <label class="radio-card"
                   [class.active]="cheDoHienThi === 'PUBLIC'">
              <input type="radio" name="vis" value="PUBLIC"
                     [(ngModel)]="cheDoHienThi" hidden>
              <i class="fas fa-globe-asia"></i> C√¥ng khai
            </label>
            <label class="radio-card"
                   [class.active]="cheDoHienThi === 'PRIVATE'">
              <input type="radio" name="vis" value="PRIVATE"
                     [(ngModel)]="cheDoHienThi" hidden>
              <i class="fas fa-lock"></i> Ri√™ng t∆∞
            </label>
          </div>
        </div>

        <div class="filter-group">
          <label class="group-label">Ch·ªß ƒë·ªÅ</label>
          <div class="select-wrapper">
            <select [(ngModel)]="chuDeId" class="custom-select">
              <option [value]="0">üìö T·∫•t c·∫£ ch·ªß ƒë·ªÅ</option>
              @for (cd of chuDes; track cd.id) {
                <option [value]="cd.id">{{ cd.ten }}</option>
              }
            </select>
            <i class="fas fa-chevron-down arrow"></i>
          </div>
        </div>

        <div class="filter-group">
          <label class="group-label">Tr·∫°ng th√°i duy·ªát</label>
          <div class="select-wrapper">
            <select [(ngModel)]="trangThai" class="custom-select">
              @for (opt of trangThaiOptions; track opt.value) {
                <option [value]="opt.value">{{ opt.label }}</option>
              }
            </select>
            <i class="fas fa-chevron-down arrow"></i>
          </div>
        </div>

        <div class="filter-group">
          <label class="group-label">Gi√° m·ªü kh√≥a</label>
          <div class="toggle-col">
            <label class="radio-card"
                   [class.active]="priceFilter === 'ALL'">
              <input type="radio" name="price" value="ALL"
                     [(ngModel)]="priceFilter" hidden>
              <i class="fas fa-coins"></i> T·∫•t c·∫£
            </label>
            <label class="radio-card"
                   [class.active]="priceFilter === 'FREE'">
              <input type="radio" name="price" value="FREE"
                     [(ngModel)]="priceFilter" hidden>
              <i class="fas fa-gift"></i> Mi·ªÖn ph√≠
            </label>
            <label class="radio-card"
                   [class.active]="priceFilter === 'PAID'">
              <input type="radio" name="price" value="PAID"
                     [(ngModel)]="priceFilter" hidden>
              <i class="fas fa-key"></i> M·∫•t ph√≠
            </label>
          </div>
        </div>

        <div class="filter-group">
          <label class="group-label">ƒê√°nh gi√°</label>
          <div class="select-wrapper">
            <select [(ngModel)]="minRating" class="custom-select">
              @for (opt of ratingOptions; track opt.value) {
                <option [ngValue]="opt.value">{{ opt.label }}</option>
              }
            </select>
            <i class="fas fa-chevron-down arrow"></i>
          </div>
        </div>

        <div class="panel-actions">
          <button class="btn-glass primary" (click)="applyFilter()">
            <i class="fas fa-filter"></i> √Åp d·ª•ng
          </button>
          <button class="btn-glass secondary" (click)="clearFilter()">
            <i class="fas fa-redo"></i> X√≥a l·ªçc
          </button>
        </div>
      </aside>

      <main class="card-grid-area">
        @if (myQuizzes.length > 0) {
          <section class="quiz-section">
            <div class="section-header-arrow">
              <span class="section-title">B·ªô c√¢u h·ªèi c·ªßa t√¥i</span>
              <span class="arrow-head"></span>
            </div>
            <div class="card-grid">
              @for (quiz of myQuizzes; track quiz.id) {
                <div class="skill-card" [ngClass]="{
                     'status-approved': quiz.trang_thai === 'DA_DUYET',
                     'status-pending': quiz.trang_thai === 'CHO_DUYET',
                     'status-rejected': quiz.trang_thai === 'TU_CHOI'
                   }">
                  <ng-container
                    *ngTemplateOutlet="quizCard; context: { $implicit: quiz }"></ng-container>
                </div>
              }
            </div>
          </section>
        }

        @if (standaloneQuizzes.length > 0) {
          <section class="quiz-section">
            <div class="section-header-arrow secondary">
              <span class="section-title">B·ªô c√¢u h·ªèi ri√™ng l·∫ª</span>
              <span class="arrow-head"></span>
            </div>
            <div class="card-grid">
              @for (quiz of standaloneQuizzes; track quiz.id) {
                <div class="skill-card" [ngClass]="{
                     'status-approved': quiz.trang_thai === 'DA_DUYET',
                     'status-pending': quiz.trang_thai === 'CHO_DUYET',
                     'status-rejected': quiz.trang_thai === 'TU_CHOI'
                   }">
                  <ng-container
                    *ngTemplateOutlet="quizCard; context: { $implicit: quiz }"></ng-container>
                </div>
              }
            </div>
          </section>
        }

        @if (courseQuizzes.length > 0) {
          <section class="quiz-section">
            <div class="section-header-arrow tertiary">
              <span class="section-title">B·ªô c√¢u h·ªèi thu·ªôc kh√≥a h·ªçc</span>
              <span class="arrow-head"></span>
            </div>
            <div class="card-grid">
              @for (quiz of courseQuizzes; track quiz.id) {
                <div class="skill-card" [ngClass]="{
                     'status-approved': quiz.trang_thai === 'DA_DUYET',
                     'status-pending': quiz.trang_thai === 'CHO_DUYET',
                     'status-rejected': quiz.trang_thai === 'TU_CHOI'
                   }">
                  <ng-container
                    *ngTemplateOutlet="quizCard; context: { $implicit: quiz }"></ng-container>
                </div>
              }
            </div>
          </section>
        }

        @if (myQuizzes.length === 0 && standaloneQuizzes.length === 0 &&
        courseQuizzes.length === 0) {
          <div class="empty-state-card">
            <img
              src="https://cdn-icons-png.flaticon.com/512/7486/7486747.png"
              alt="Empty">
            <h3>Kho t√†ng tr·ªëng r·ªóng!</h3>
            <p>Ch∆∞a t√¨m th·∫•y b·ªô c√¢u h·ªèi n√†o ph√π h·ª£p.</p>
          </div>
        }

        <ng-template #quizCard let-quiz>
          <div class="card-top">
            <div class="icon-box">
              <i class="fas fa-book"></i>
            </div>
            <div class="badges-stack">
            <span class="badge-pill status-badge">
              @if (quiz.trang_thai === 'DA_DUYET') {
                <i class="fas fa-check-circle"></i> ƒê√£ duy·ªát
              } @else if (quiz.trang_thai === 'CHO_DUYET') {
                <i class="fas fa-clock"></i> Ch·ªù duy·ªát
              } @else if (quiz.trang_thai === 'TU_CHOI') {
                <i class="fas fa-ban"></i> T·ª´ ch·ªëi
              }
            </span>
              <span class="badge-pill visibility-badge"
                    [class.is-private]="quiz.che_do_hien_thi === 'PRIVATE'">
              @if (quiz.che_do_hien_thi === 'PUBLIC') {
                <i class="fas fa-globe"></i> Public
              } @else {
                <i class="fas fa-lock"></i> Private
              }
            </span>
            </div>
          </div>

          <div class="card-body">
          <span class="category-tag">
            {{ quiz.chu_de || 'General' }}
            @if (quiz.thuoc_khoa_hoc && quiz.khoa_hoc_ten) {
              ¬∑ <i class="fas fa-graduation-cap"></i> {{
                quiz.khoa_hoc_ten
              }}
            }
          </span>
            <h3 class="card-title"
                [innerHTML]="highlightKeyword(quiz.tieu_de)"></h3>
            <div class="card-meta">
              <span class="meta-item"><i
                class="fas fa-user-astronaut"></i> {{
                  quiz.nguoi_tao || '·∫®n danh'
                }}</span>
              @if (quiz.tong_danh_gia > 0) {
                <span class="meta-item rating-display">
                  <i class="fas fa-star text-warning"></i>
                  {{ quiz.trung_binh_sao | number:'1.1-1' }}
                  <span class="rating-count">({{ quiz.tong_danh_gia }})</span>
                </span>
              }
            </div>
            <p class="card-desc">
              {{ quiz.mo_ta || 'Ch∆∞a c√≥ m√¥ t·∫£ cho b·ªô c√¢u h·ªèi n√†y.' }}
            </p>
          </div>

          <div class="card-actions">
            <button class="action-btn btn-view"
                    (click)="navigateDetail(quiz.id)" title="Xem chi ti·∫øt">
              <i class="fas fa-eye"></i>
            </button>

            <button class="action-btn btn-edit"
                    [class.disabled]="!canEdit(quiz)"
                    (click)="canEdit(quiz) ? navigateEdit(quiz.id) : showAccessDeniedAlert('ch·ªânh s·ª≠a')"
                    title="Ch·ªânh s·ª≠a">
              <i class="fas"
                 [ngClass]="canEdit(quiz) ? 'fa-pen' : 'fa-lock'"></i>
            </button>

            <button class="action-btn btn-delete"
                    [class.disabled]="!canDelete(quiz)"
                    (click)="canDelete(quiz) ? confirmDelete(quiz.id) : showAccessDeniedAlert('x√≥a')"
                    title="X√≥a">
              <i class="fas"
                 [ngClass]="canDelete(quiz) ? 'fa-trash' : 'fa-lock'"></i>
            </button>

            <button class="action-btn btn-play"
                    [disabled]="unlocking_id === quiz.id"
                    (click)="handlePracticeClick(quiz)">
              @if (unlocking_id === quiz.id) {
                <i class="fas fa-spinner fa-spin"></i>
              } @else {
                @if (quiz.can_mo_khoa && !quiz.da_mo_khoa) {
                  <span class="unlock-text"><i class="fas fa-key"></i> {{
                      quiz.gia_mo_khoa
                    }}G</span>
                } @else {
                  <span class="play-text"><i class="fas fa-play"></i>
              Luy·ªán</span>
                }
              }
            </button>
          </div>
        </ng-template>

        @if (totalPages > 1) {
          <div class="pagination-wrapper">
            <button class="page-btn nav-prev"
                    (click)="changePage(page - 1)" [disabled]="page === 0">
              <i class="fas fa-chevron-left"></i>
            </button>

            <div class="page-numbers">
              @for (p of getVisiblePages(); track $index) {
                @if (p >= 0) {
                  <button class="page-btn" [class.active]="p === page"
                          (click)="changePage(p)">
                    {{ p + 1 }}
                  </button>
                } @else {
                  <span class="dots">...</span>
                }
              }
            </div>

            <button class="page-btn nav-next"
                    (click)="changePage(page + 1)"
                    [disabled]="page === totalPages - 1">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        }

      </main>
    </div>
  </div>
} @else {
  <div class="loading-screen">
    <div class="spinner-box">
      <div class="spinner"></div>
      <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>
  </div>
}
