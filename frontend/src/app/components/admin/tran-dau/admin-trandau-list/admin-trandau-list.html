<div class="admin-match-page animate-fade-down">

  <div class="page-header">
    <div>
      <h2 class="page-title">Qu·∫£n l√Ω tr·∫≠n ƒë·∫•u</h2>
      <p class="page-subtitle">Theo d√µi v√† qu·∫£n l√Ω c√°c ph√≤ng ƒë·∫•u theo th·ªùi gian th·ª±c.</p>
    </div>
    <button class="btn-refresh" (click)="refreshData()">
      <i class="fas fa-sync-alt" [class.fa-spin]="loadingStats"></i> C·∫≠p nh·∫≠t d·ªØ li·ªáu
    </button>
  </div>

  <div class="stats-grid">
    <div class="stat-card blue">
      <div class="icon"><i class="fas fa-gamepad"></i></div>
      <div class="info">
        <span class="lbl">ƒêang di·ªÖn ra</span>
        <span class="val">{{ stats.ongoingBattles | number }}</span>
      </div>
    </div>
    <div class="stat-card orange">
      <div class="icon"><i class="fas fa-hourglass-half"></i></div>
      <div class="info">
        <span class="lbl">Ph√≤ng ch·ªù</span>
        <span class="val">{{ stats.pendingBattles | number }}</span>
      </div>
    </div>
    <div class="stat-card green">
      <div class="icon"><i class="fas fa-check-circle"></i></div>
      <div class="info">
        <span class="lbl">ƒê√£ xong h√¥m nay</span>
        <span class="val">{{ stats.todayBattles | number }}</span>
      </div>
    </div>
    <div class="stat-card purple">
      <div class="icon"><i class="fas fa-history"></i></div>
      <div class="info">
        <span class="lbl">T·ªïng l·ªãch s·ª≠</span>
        <span class="val">{{ stats.totalHistories | number }}</span>
      </div>
    </div>
  </div>

  <div class="section-title">
    <h3><i class="fas fa-satellite-dish pulse"></i> Ph√≤ng ƒëang ho·∫°t ƒë·ªông</h3>
  </div>

  @if (loadingPending) {
    <div class="loading-state">
      <div class="spinner"></div>
      ƒêang t·∫£i danh s√°ch ph√≤ng...
    </div>
  } @else if (pendingBattles.length === 0) {
    <div class="empty-state-card">
      <i class="fas fa-coffee"></i>
      <p>Hi·ªán kh√¥ng c√≥ ph√≤ng n√†o ƒëang ch·ªù.</p>
    </div>
  } @else {
    <div class="room-grid">
      @for (room of pendingBattles; track room.id) {
        <div class="room-card" (click)="viewRoomDetail(room)">
          <div class="room-header">
            <span class="room-id">#{{ room.id }}</span>
            <span class="room-badge" [class.ranked]="room.loai_tran_dau === 'RANKED'">
              {{ room.loai_tran_dau === 'RANKED' ? 'Ranked' : 'Casual' }}
            </span>
          </div>
          <h4 class="room-name">{{ room.ten_phong }}</h4>
          <p class="room-quiz"><i class="fas fa-book"></i> {{ room.bo_cau_hoi_tieu_de || 'Ch∆∞a ch·ªçn b·ªô' }}</p>

          <div class="room-footer">
            <div class="host-info">
              <div class="host-avt">{{ (room.chu_phong_ten || '?')[0] | uppercase }}</div>
              <span class="host-name">{{ room.chu_phong_ten }}</span>
            </div>
            <div class="room-meta">
              <span class="users"><i class="fas fa-users"></i> {{ room.da_tham_gia }}
                /{{ room.gioi_han_nguoi_choi }}</span>
            </div>
          </div>

          <div class="room-overlay">
            <button class="btn-overlay" (click)="$event.stopPropagation(); closeRoom(room.id)">
              <i class="fas fa-times-circle"></i> ƒê√≥ng ph√≤ng
            </button>
          </div>
        </div>
      }
    </div>
  }

  <div class="history-section">
    <div class="section-header">
      <h3><i class="fas fa-history"></i> L·ªãch s·ª≠ ƒë·∫•u to√†n h·ªá th·ªëng</h3>
      <div class="actions">
        <button class="btn-icon" (click)="showFilter = !showFilter" [class.active]="showFilter">
          <i class="fas fa-filter"></i>
        </button>
        <button class="btn-export" (click)="exportCsv()">
          <i class="fas fa-file-csv"></i> Xu·∫•t CSV
        </button>
      </div>
    </div>

    @if (showFilter) {
      <div class="filter-panel animate-fade-down">
        <div class="filter-group">
          <input type="text" [(ngModel)]="keyword" placeholder="T√¨m ki·∫øm..." (keyup.enter)="onHistorySearch()">
          <select [(ngModel)]="loaiTranDauFilter" (change)="onHistorySearch()">
            <option value="">T·∫•t c·∫£ ch·∫ø ƒë·ªô</option>
            <option value="RANKED">Ranked</option>
            <option value="CASUAL">Casual</option>
          </select>
          <input type="date" [(ngModel)]="fromDateFilter">
          <input type="date" [(ngModel)]="toDateFilter">
          <button class="btn-apply" (click)="onHistorySearch()">√Åp d·ª•ng</button>
          <button class="btn-reset" (click)="clearFilters()">X√≥a</button>
        </div>
      </div>
    }

    <div class="table-card custom-scrollbar">
      @if (loadingHistory) {
        <div class="loading-state">
          <div class="spinner"></div>
          ƒêang t·∫£i l·ªãch s·ª≠...
        </div>
      } @else {
        <table class="modern-table">
          <thead>
          <tr>
            <th>ID</th>
            <th>Th·ªùi gian</th>
            <th>Ph√≤ng / B·ªô c√¢u h·ªèi</th>
            <th>Ng∆∞·ªùi ch∆°i</th>
            <th>K·∫øt qu·∫£</th>
            <th>Thao t√°c</th>
          </tr>
          </thead>
          <tbody>
            @for (h of historyItems; track h.lich_su_id) {
              <tr>
                <td class="text-muted">#{{ h.lich_su_id }}</td>
                <td>
                  <div class="time-cell">
                    <span class="date">{{ h.hoan_thanh_luc | date:'dd/MM/yyyy' }}</span>
                    <span class="time">{{ h.hoan_thanh_luc | date:'HH:mm' }}</span>
                  </div>
                </td>
                <td>
                  <div class="room-cell">
                    <span class="r-name">{{ h.ten_phong }}</span>
                    <span class="q-name">{{ h.bo_cau_hoi_tieu_de }}</span>
                  </div>
                </td>
                <td>
                  <div class="user-cell">
                    <div class="u-avt">{{ (h.ten_hien_thi || '?')[0] | uppercase }}</div>
                    <span class="u-name">{{ h.ten_hien_thi }}</span>
                  </div>
                </td>
                <td>
                  <div class="result-cell">
                    <span class="rank-badge" [ngClass]="'top-' + h.xep_hang">
                      {{ h.xep_hang === 1 ? 'ü•á TOP 1' : (h.xep_hang === 2 ? 'ü•à TOP 2' : (h.xep_hang === 3 ? 'ü•â TOP 3' : 'Rank ' + h.xep_hang)) }}
                    </span>
                    <span class="score">{{ h.tong_diem }} pts</span>
                  </div>
                </td>
                <td>
                  <div ngbDropdown container="body" placement="bottom-end" class="d-inline-block">
                    <button class="btn-more" ngbDropdownToggle><i class="fas fa-ellipsis-v"></i></button>
                    <div ngbDropdownMenu class="custom-dropdown">
                      <button ngbDropdownItem (click)="viewHistoryDetail(h)">
                        <i class="fas fa-eye"></i> Xem chi ti·∫øt
                      </button>
                      <div class="dropdown-divider"></div>
                      <button ngbDropdownItem class="text-danger" (click)="deleteHistory(h.lich_su_id)">
                        <i class="fas fa-trash"></i> X√≥a l·ªãch s·ª≠
                      </button>
                    </div>
                  </div>
                </td>
              </tr>
            }
            @if (historyItems.length === 0) {
              <tr>
                <td colspan="6" class="empty-table">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠.</td>
              </tr>
            }
          </tbody>
        </table>
      }
    </div>

    @if (historyTotalPages > 1) {
      <div class="pagination-container">
        <button class="btn-page" (click)="goHistoryPage(historyPage - 1)" [disabled]="historyPage === 0"><i
          class="fas fa-chevron-left"></i></button>
        <span class="page-info">Trang {{ historyPage + 1 }} / {{ historyTotalPages }}</span>
        <button class="btn-page" (click)="goHistoryPage(historyPage + 1)"
                [disabled]="historyPage >= historyTotalPages - 1"><i class="fas fa-chevron-right"></i></button>
      </div>
    }
  </div>

  @if (showRoomModal && roomDetail) {
    <div class="modal-backdrop fade-in" (click)="closeRoomModal()">
      <div class="modal-panel slide-up" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Chi ti·∫øt ph√≤ng #{{ roomDetail.id }}</h3>
          <button class="btn-close" (click)="closeRoomModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div class="room-info-grid">
            <div class="info-group">
              <label>T√™n ph√≤ng</label>
              <span>{{ roomDetail.ten_phong }}</span>
            </div>
            <div class="info-group">
              <label>M√£ ph√≤ng</label>
              <code class="room-code">{{ roomDetail.ma_phong }}</code>
            </div>
            <div class="info-group">
              <label>Ch·∫ø ƒë·ªô</label>
              <span class="badge"
                    [class.ranked]="roomDetail.loai_tran_dau === 'RANKED'">{{ roomDetail.loai_tran_dau }}</span>
            </div>
            <div class="info-group">
              <label>Tr·∫°ng th√°i</label>
              <span class="status-text">{{ roomDetail.trang_thai }}</span>
            </div>
          </div>

          <div class="player-list-section">
            <h4>Danh s√°ch ng∆∞·ªùi ch∆°i ({{ roomDetail.nguoi_choi?.length || 0 }})</h4>
            <div class="player-list custom-scrollbar">
              @for (p of roomDetail.nguoi_choi; track p.id) {
                <div class="player-item">
                  <img [src]="p.avatar || 'assets/images/default-avatar.png'" class="p-avt">
                  <div class="p-info">
                    <span class="p-name">{{ p.ho_ten }}</span>
                    @if (p.is_host) {
                    <span class="p-role">üëë Ch·ªß ph√≤ng</span>
                    }
                  </div>
                  @if (!p.is_host) {
                    <button class="btn-kick" (click)="kickPlayer(roomDetail.id, p.id, p.ho_ten)" title="Kick">
                      <i class="fas fa-sign-out-alt"></i>
                    </button>
                  }
                </div>
              }
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-danger" (click)="closeRoom(roomDetail.id)">ƒê√≥ng ph√≤ng n√†y</button>
        </div>
      </div>
    </div>
  }

</div>
