<div class="chat-layout">
  <div class="bg-decor-1"></div>
  <div class="bg-decor-2"></div>

  <div class="chat-container card-3d">

    <aside class="chat-sidebar">
      <header class="sidebar-header">
        <h2>Tin nh·∫Øn</h2>
        <div class="header-actions">
          <button class="btn-icon" title="T·∫°o nh√≥m"
            (click)="openCreateGroupModal()">
            <i class="fas fa-users"></i>
          </button>
          <button class="btn-icon" title="C√†i ƒë·∫∑t"><i
              class="fas fa-cog"></i></button>
        </div>
      </header>

      <!-- Tabs -->
      <div class="sidebar-tabs">
        <button class="tab-btn"
          [class.active]="activeTab === 'friends'"
          (click)="switchTab('friends')">
          <i class="fas fa-user"></i>
          <span>B·∫°n b√®</span>
        </button>
        <button class="tab-btn"
          [class.active]="activeTab === 'groups'"
          (click)="switchTab('groups')">
          <i class="fas fa-users"></i>
          <span>Nh√≥m</span>
        </button>
      </div>

      <div class="search-wrapper">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="T√¨m ki·∫øm cu·ªôc tr√≤ chuy·ªán...">
      </div>

      <div class="sidebar-body custom-scrollbar">
        <!-- Friends Tab -->
        @if (activeTab === 'friends') {
        @if (inbox_loading && inbox_items.length === 0) {
        <div class="loading-state">
          <div class="spinner-sm"></div>
          ƒêang t·∫£i...
        </div>
        } @else {
        @if (inbox_items.length === 0) {
        <div class="empty-state">
          <i class="fas fa-user-friends"></i>
          <p>Ch∆∞a c√≥ b·∫°n b√® n√†o</p>
        </div>
        } @else {
        <div class="conversation-list">
          @for (item of inbox_items; track item.partner_id) {
          <div class="conv-item"
            [class.active]="active_partner?.partner_id === item.partner_id"
            (click)="select_partner(item)">

            <div class="avatar-wrapper">
              <img
                [src]="getAvatar(item.partner_avatar_url, item.partner_name)"
                class="avatar">
              <div class="status-dot"
                [class.online]="item.partner_status === 'ONLINE'">
              </div>
            </div>

            <div class="conv-info">
              <div class="conv-top">
                <span class="name">{{ item.partner_name }}</span>
                <span class="time">{{ item.last_time | date:'HH:mm'
                  }}</span>
              </div>
              <div class="conv-bottom">
                <span class="last-msg"
                  [class.unread]="(item.unread_count ?? 0) > 0">
                  {{ item.last_message || 'B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán' }}
                </span>
                @if ((item.unread_count ?? 0) > 0) {
                <span class="badge">{{ (item.unread_count ?? 0) > 9 ?
                  '9+' : item.unread_count }}</span>
                }
              </div>
            </div>
          </div>
          }
        </div>
        }
        }
        }

        <!-- Groups Tab -->
        @if (activeTab === 'groups') {
        @if (groups_loading && groups.length === 0) {
        <div class="loading-state">
          <div class="spinner-sm"></div>
          ƒêang t·∫£i...
        </div>
        } @else {
        @if (groups.length === 0) {
        <div class="empty-state">
          <i class="fas fa-comments"></i>
          <p>Ch∆∞a c√≥ nh√≥m chat n√†o</p>
          <button class="btn-create-group"
            (click)="openCreateGroupModal()">
            <i class="fas fa-plus"></i>
            T·∫°o nh√≥m m·ªõi
          </button>
        </div>
        } @else {
        <div class="conversation-list">
          @for (group of groups; track group.id) {
          <div class="conv-item"
            [class.active]="activeGroup?.id === group.id"
            (click)="select_group(group)">

            <div class="avatar-wrapper">
              <img [src]="getGroupAvatar(group)" class="avatar">
              @if (group.loai === LoaiPhongChat.NHOM) {
              <div class="group-badge">
                <i class="fas fa-users"></i>
              </div>
              }
            </div>

            <div class="conv-info">
              <div class="conv-top">
                <span class="name">{{ getGroupDisplayName(group)
                  }}</span>
                <span class="time">{{ group.thoiGianTinNhanCuoi |
                  date:'HH:mm' }}</span>
              </div>
              <div class="conv-bottom"><span class="last-msg"
                  [class.unread]="group.soTinNhanChuaDoc > 0">{{
                  group.tinNhanCuoi || 'B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán' }}</span>
                @if (group.soTinNhanChuaDoc > 0) {
                <span class="badge">{{ group.soTinNhanChuaDoc > 9 ?
                  '9+' : group.soTinNhanChuaDoc }}</span>
                }
              </div>
            </div>
          </div>
          }
        </div>
        }
        }
        }
      </div>
    </aside>

    <section class="chat-main">
      <!-- Welcome Screen - No chat selected -->
      @if (!active_partner && !activeGroup) {
      <div class="welcome-screen animate-fade-up">
        <div class="welcome-icon">üëã</div>
        <h3>Xin ch√†o, {{ meName }}!</h3>
        <p>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
      </div>
      }

      <!-- Friend Chat -->
      @if (active_partner && activeChatType === 'friend') {
      <header class="chat-header">
        <div class="partner-details">
          <div class="avatar-wrapper sm">
            <img
              [src]="getAvatar(active_partner.partner_avatar_url, active_partner.partner_name)"
              class="avatar">
            <div class="status-dot"
              [class.online]="active_partner.partner_status === 'ONLINE'">
            </div>
          </div>
          <div class="info">
            <h3 class="name">{{ active_partner.partner_name }}</h3>
            <span class="status-text">
              {{ active_partner.partner_status === 'ONLINE' ? 'ƒêang
              ho·∫°t ƒë·ªông' : 'Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y' }}
            </span>
          </div>
        </div>
        <div class="chat-actions">
          <button class="btn-icon"><i
              class="fas fa-phone-alt"></i></button>
          <button class="btn-icon"><i
              class="fas fa-video"></i></button>
          <button class="btn-icon"><i
              class="fas fa-info-circle"></i></button>
        </div>
      </header>

      <div class="messages-area custom-scrollbar" #messagesContainer>
        @if (messages_loading && messages.length === 0) {
        <div class="loading-state full">
          <div class="spinner-3d"></div>
        </div>
        } @else {

        @if (messages_has_more && !messages_loading) {
        <div class="load-more-wrapper">
          <button class="btn-load-more"
            (click)="load_more_messages()">T·∫£i tin nh·∫Øn c≈©</button>
        </div>
        }

        @if (messages.length === 0) {
        <div class="empty-chat-state">
          <img
            [src]="getAvatar(active_partner.partner_avatar_url, active_partner.partner_name)"
            class="lg-avatar">
          <p>C√°c b·∫°n ƒë√£ l√† b·∫°n b√®. H√£y g·ª≠i l·ªùi ch√†o!</p>
          <div class="wave-emoji">üëã</div>
        </div>
        }

        <div class="msg-list">
          @for (m of messages; track $index) {
          <div class="msg-row" [class.mine]="m.la_toi"
            [class.partner]="!m.la_toi">

            @if (!m.la_toi) {
            <img
              [src]="getAvatar(active_partner.partner_avatar_url, active_partner.partner_name)"
              class="mini-avatar">
            }

            <div class="bubble-wrapper">
              <!-- Text message -->
              @if (!m.loai_tin_nhan || m.loai_tin_nhan === 'VAN_BAN')
              {
              <div class="bubble"
                [title]="m.gui_luc | date:'dd/MM/yyyy HH:mm'">
                {{ m.noi_dung }}
              </div>
              }
              <!-- Image message -->
              @else if (m.loai_tin_nhan === 'HINH_ANH') {
              <div class="bubble image-bubble"
                [title]="m.gui_luc | date:'dd/MM/yyyy HH:mm'">
                <img [src]="API_URL + '/chat/files/' + m.url_media"
                  alt="·∫¢nh" loading="lazy">
              </div>
              }
              <!-- File message -->
              @else if (m.loai_tin_nhan === 'TAP_TIN') {
              <div class="bubble file-bubble"
                [title]="m.gui_luc | date:'dd/MM/yyyy HH:mm'">
                <a [href]="m.url_media ? (API_URL + '/chat/files/' + m.url_media) : '#'"
                  target="_blank"
                  [attr.download]="m.ten_file || 'file'">
                  <i class="fas fa-file-alt"></i>
                  <span class="file-name">{{ m.ten_file || 'T·ªáp ƒë√≠nh
                    k√®m' }}</span>
                  @if (m.kich_thuoc_file) {
                  <small class="file-size">({{
                    formatFileSize(m.kich_thuoc_file) }})</small>
                  }
                </a>
              </div>
              }
              <!-- Audio message -->
              @else if (m.loai_tin_nhan === 'AM_THANH') {
              <div class="bubble audio-bubble"
                [title]="m.gui_luc | date:'dd/MM/yyyy HH:mm'">
                <audio controls
                  [src]="API_URL + '/chat/files/' + m.url_media"></audio>
              </div>
              }
              @else {
              <div class="bubble"
                [title]="m.gui_luc | date:'dd/MM/yyyy HH:mm'">
                {{ m.noi_dung }}
              </div>
              }
              <span class="msg-time">{{ m.gui_luc | date:'HH:mm'
                }}</span>
            </div>
          </div>
          }
        </div>
        }
      </div>

      <footer class="chat-footer">
        <button class="btn-tool" title="G·ª≠i ·∫£nh"
          (click)="openImageSelector()">
          <i class="fas fa-image"></i>
        </button>
        <button class="btn-tool" title="G·ª≠i file"
          (click)="openFileSelector()">
          <i class="fas fa-paperclip"></i>
        </button>

        <div class="input-box">
          <textarea #chatInput [(ngModel)]="new_message_noi_dung"
            placeholder="Nh·∫≠p tin nh·∫Øn..."
            (keydown.enter)="on_enter_send($any($event))"
            (input)="autoResize()" rows="1">
            </textarea>

          <button class="btn-emoji" (click)="toggleEmojiPicker()"
            [class.active]="showEmojiPicker()">
            <i class="far fa-smile"></i>
          </button>
        </div>

        <button class="btn-send" (click)="send_message()"
          [disabled]="!new_message_noi_dung.trim() && !uploadingFile">
          @if (uploadingFile) {
          <i class="fas fa-spinner fa-spin"></i>
          } @else {
          <i class="fas fa-paper-plane"></i>
          }
        </button>

        <!-- Hidden file input -->
        <input type="file" #fileInput style="display: none"
          (change)="onFileSelected($event)">

        @if (showEmojiPicker()) {
        <div class="emoji-popover">
          <div class="emoji-overlay"
            (click)="showEmojiPicker.set(false)"></div>
          <div class="emoji-content">
            <emoji-mart [showPreview]="false" [enableSearch]="true"
              [darkMode]="false" color="#6C5DD3"
              (emojiClick)="addEmoji($event)">
            </emoji-mart>
          </div>
        </div>
        }
      </footer>
      }

      <!-- Group Chat -->
      @if (activeGroup && activeChatType === 'group') {
      <header class="chat-header">
        <div class="partner-details">
          <div class="avatar-wrapper sm">
            <img [src]="getGroupAvatar(activeGroup)" class="avatar">
          </div>
          <div class="info">
            <h3 class="name">{{ getGroupDisplayName(activeGroup) }}
            </h3>
            <span class="status-text">{{ activeGroup.thanhVien.length
              || 0 }} th√†nh vi√™n</span>
          </div>
        </div>
        <div class="chat-actions">
          <button class="btn-icon" title="Th√™m th√†nh vi√™n"
            (click)="openAddMembersModal()">
            <i class="fas fa-user-plus"></i>
          </button>
          <button class="btn-icon" title="C√†i ƒë·∫∑t nh√≥m"
            (click)="openGroupSettings()">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </header>

      <div class="messages-area custom-scrollbar" #messagesContainer>
        @if (groupMessages_loading && groupMessages.length === 0) {
        <div class="loading-state full">
          <div class="spinner-3d"></div>
        </div>
        } @else {

        @if (groupMessages_has_more && !groupMessages_loading) {
        <div class="load-more-wrapper">
          <button class="btn-load-more"
            (click)="load_more_group_messages()">T·∫£i tin nh·∫Øn
            c≈©</button>
        </div>
        }

        @if (groupMessages.length === 0) {
        <div class="empty-chat-state">
          <img [src]="getGroupAvatar(activeGroup)" class="lg-avatar">
          <p>Nh√≥m ƒë√£ ƒë∆∞·ª£c t·∫°o. H√£y g·ª≠i tin nh·∫Øn ƒë·∫ßu ti√™n!</p>
          <div class="wave-emoji">üí¨</div>
        </div>
        }

        <div class="msg-list">
          @for (m of groupMessages; track $index) {
          <div class="msg-row" [class.mine]="m.laToi"
            [class.partner]="!m.laToi"
            [class.system]="m.loai === LoaiTinNhan.HE_THONG">

            @if (m.loai === LoaiTinNhan.HE_THONG) {
            <div class="system-message">
              <i class="fas fa-info-circle"></i>
              {{ m.noiDung }}
            </div>
            } @else {
            @if (!m.laToi) {
            <img
              [src]="getAvatar(m.nguoiGui.anhDaiDien, m.nguoiGui.ten || 'User')"
              class="mini-avatar">
            }

            <div class="bubble-wrapper">
              @if (!m.laToi) {
              <span class="sender-name">{{ m.nguoiGui.ten }}</span>
              }
              <div class="bubble"
                [title]="m.guiLuc | date:'dd/MM/yyyy HH:mm'">
                @if (m.loai === LoaiTinNhan.HINH_ANH && m.urlMedia) {
                <img [src]="m.urlMedia" class="msg-image" alt="Image">
                } @else if (m.loai === LoaiTinNhan.TAP_TIN &&
                m.urlMedia) {
                <a [href]="m.urlMedia" target="_blank"
                  class="file-attachment">
                  <i class="fas fa-file"></i>
                  {{ m.tenFile || 'T·∫≠p tin' }}
                </a>
                } @else {
                {{ m.noiDung }}
                }
              </div>
              <span class="msg-time">{{ m.guiLuc | date:'HH:mm'
                }}</span>
            </div>
            }
          </div>
          }
        </div>
        }
      </div>

      <footer class="chat-footer">
        <button class="btn-tool"><i
            class="fas fa-plus-circle"></i></button>

        <div class="input-box">
          <textarea #chatInput [(ngModel)]="new_message_noi_dung"
            placeholder="Nh·∫≠p tin nh·∫Øn..."
            (keydown.enter)="on_enter_send($any($event))"
            (input)="autoResize()" rows="1">
            </textarea>

          <button class="btn-emoji" (click)="toggleEmojiPicker()"
            [class.active]="showEmojiPicker()">
            <i class="far fa-smile"></i>
          </button>
        </div>

        <!-- File upload buttons -->
        <button class="btn-tool" title="G·ª≠i ·∫£nh"
          (click)="openImageSelector()" [disabled]="uploadingFile">
          <i class="fas fa-image"></i>
        </button>
        <button class="btn-tool" title="G·ª≠i file"
          (click)="openFileSelector()" [disabled]="uploadingFile">
          <i class="fas fa-paperclip"></i>
        </button>

        <button class="btn-send" (click)="send_group_message()"
          [disabled]="(!new_message_noi_dung.trim() && !uploadingFile) || uploadingFile">
          @if (uploadingFile) {
          <i class="fas fa-spinner fa-spin"></i>
          } @else {
          <i class="fas fa-paper-plane"></i>
          }
        </button>

        <!-- Hidden file input -->
        <input type="file" #fileInput style="display: none"
          (change)="onFileSelected($event)">

        @if (showEmojiPicker()) {
        <div class="emoji-popover">
          <div class="emoji-overlay"
            (click)="showEmojiPicker.set(false)"></div>
          <div class="emoji-content">
            <emoji-mart [showPreview]="false" [enableSearch]="true"
              [darkMode]="false" color="#6C5DD3"
              (emojiClick)="addEmoji($event)">
            </emoji-mart>
          </div>
        </div>
        }
      </footer>
      }
    </section>
  </div>

  <!-- Create Group Modal -->
  @if (showCreateGroupModal) {
  <div class="modal-overlay" (click)="closeCreateGroupModal()">
    <div class="modal-content create-group-modal"
      (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3><i class="fas fa-users"></i> T·∫°o nh√≥m chat m·ªõi</h3>
        <button class="btn-close" (click)="closeCreateGroupModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>T√™n nh√≥m</label>
          <input type="text" [(ngModel)]="newGroupName"
            placeholder="Nh·∫≠p t√™n nh√≥m..." class="form-input">
        </div>

        <div class="form-group">
          <label>Ch·ªçn th√†nh vi√™n ({{ selectedMemberIds.length }} ƒë√£
            ch·ªçn)</label>
          <div class="member-list">
            @for (friend of inbox_items; track friend.partner_id) {
            <div class="member-item"
              [class.selected]="isMemberSelected(friend.partner_id)"
              (click)="toggleMemberSelection(friend.partner_id)">
              <img
                [src]="getAvatar(friend.partner_avatar_url, friend.partner_name)"
                class="avatar-sm">
              <span class="member-name">{{ friend.partner_name
                }}</span>
              <div class="checkbox">
                @if (isMemberSelected(friend.partner_id)) {
                <i class="fas fa-check-circle"></i>
                } @else {
                <i class="far fa-circle"></i>
                }
              </div>
            </div>
            }
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel"
          (click)="closeCreateGroupModal()">H·ªßy</button>
        <button class="btn-create"
          [disabled]="!newGroupName.trim() || selectedMemberIds.length === 0"
          (click)="createGroup()">
          <i class="fas fa-plus"></i>
          T·∫°o nh√≥m
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Group Settings Panel -->
  @if (showGroupSettings && activeGroup) {
  <div class="modal-overlay" (click)="closeGroupSettings()">
    <div class="modal-content group-settings-modal"
      (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3><i class="fas fa-cog"></i> C√†i ƒë·∫∑t nh√≥m</h3>
        <button class="btn-close" (click)="closeGroupSettings()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- Group Avatar -->
        <div class="group-avatar-section">
          <div class="avatar-wrapper lg">
            <img [src]="getGroupAvatar(activeGroup)" class="avatar">
            <label class="avatar-overlay" for="groupAvatarInput">
              <i class="fas fa-camera"></i>
            </label>
            <input type="file" id="groupAvatarInput" accept="image/*"
              style="display: none"
              (change)="onGroupAvatarSelected($event)">
          </div>
        </div>

        <!-- Group Name -->
        <div class="form-group">
          <label>T√™n nh√≥m</label>
          @if (isEditingGroupName) {
          <div class="edit-name-row">
            <input type="text" [(ngModel)]="editGroupName"
              class="form-input">
            <button class="btn-icon-sm success"
              (click)="saveGroupName()">
              <i class="fas fa-check"></i>
            </button>
            <button class="btn-icon-sm"
              (click)="cancelEditGroupName()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          } @else {
          <div class="display-name-row">
            <span class="group-name-display">{{ activeGroup.ten ||
              'Ch∆∞a ƒë·∫∑t t√™n' }}</span>
            <button class="btn-icon-sm"
              (click)="startEditGroupName()">
              <i class="fas fa-pen"></i>
            </button>
          </div>
          }
        </div>

        <!-- Members List -->
        <div class="form-group">
          <label>Th√†nh vi√™n ({{ activeGroup.thanhVien.length
            }})</label>
          <div class="member-list settings-member-list">
            @for (member of activeGroup.thanhVien; track member.id) {
            <div class="member-item">
              <img [src]="getAvatar(member.anhDaiDien, member.ten)"
                class="avatar-sm">
              <div class="member-info">
                <span class="member-name">{{ member.ten }}</span>
                @if (member.vaiTro === 'ADMIN') {
                <span class="role-badge admin">Admin</span>
                }
                @if (member.nguoiDungId === current_user_id) {
                <span class="role-badge you">B·∫°n</span>
                }
              </div>
              @if (isGroupAdmin() && member.nguoiDungId !==
              current_user_id) {
              <button class="btn-kick"
                (click)="kickMember(member.nguoiDungId, member.ten)">
                <i class="fas fa-user-minus"></i>
              </button>
              }
            </div>
            }
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-danger" (click)="leaveGroup()">
          <i class="fas fa-sign-out-alt"></i>
          R·ªùi nh√≥m
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Add Members Modal -->
  @if (showAddMembersModal && activeGroup) {
  <div class="modal-overlay" (click)="closeAddMembersModal()">
    <div class="modal-content add-members-modal"
      (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3><i class="fas fa-user-plus"></i> Th√™m th√†nh vi√™n</h3>
        <button class="btn-close" (click)="closeAddMembersModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Ch·ªçn b·∫°n b√® ƒë·ªÉ th√™m ({{ addMemberSelectedIds.length
            }} ƒë√£ ch·ªçn)</label>
          <div class="member-list">
            @for (friend of inbox_items; track friend.partner_id) {
            @if (!isAlreadyMember(friend.partner_id)) {
            <div class="member-item"
              [class.selected]="isAddMemberSelected(friend.partner_id)"
              (click)="toggleAddMemberSelection(friend.partner_id)">
              <img
                [src]="getAvatar(friend.partner_avatar_url, friend.partner_name)"
                class="avatar-sm">
              <span class="member-name">{{ friend.partner_name
                }}</span>
              <div class="checkbox">
                @if (isAddMemberSelected(friend.partner_id)) {
                <i class="fas fa-check-circle"></i>
                } @else {
                <i class="far fa-circle"></i>
                }
              </div>
            </div>
            } @else {
            <div class="member-item disabled">
              <img
                [src]="getAvatar(friend.partner_avatar_url, friend.partner_name)"
                class="avatar-sm">
              <span class="member-name">{{ friend.partner_name
                }}</span>
              <span class="already-member-badge">ƒê√£ l√† th√†nh
                vi√™n</span>
            </div>
            }
            }
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel"
          (click)="closeAddMembersModal()">H·ªßy</button>
        <button class="btn-create"
          [disabled]="addMemberSelectedIds.length === 0"
          (click)="addMembersToGroup()">
          <i class="fas fa-plus"></i>
          Th√™m {{ addMemberSelectedIds.length }} th√†nh vi√™n
        </button>
      </div>
    </div>
  </div>
  }
</div>