<div class="chat-page">

  <!-- üì® C·ªôt tr√°i: Danh s√°ch b·∫°n b√® -->
  <aside class="chat-sidebar">
    <header class="sidebar-header">
      <h2>H·ªôp th∆∞</h2>
      <p class="subtitle">C√°c cu·ªôc h·ªôi tho·∫°i 1-1 v·ªõi b·∫°n b√®</p>
    </header>

    <div class="sidebar-body">
      @if (inbox_loading && inbox_items.length === 0) {
        <div class="empty">ƒêang t·∫£i danh s√°ch b·∫°n b√®...</div>
      } @else {
        @if (inbox_items.length === 0) {
          <div class="empty">B·∫°n ch∆∞a c√≥ ng∆∞·ªùi b·∫°n n√†o.</div>
        } @else {
          <ul class="conversation-list">
            @for (item of inbox_items; track item.partner_id) {
              <li
                class="conversation-item"
                [class.active]="active_partner?.partner_id === item.partner_id"
                (click)="select_partner(item)"
              >
                <div class="avatar-wrapper">
                  <img
                    [src]="'http://localhost:8088/api/v1/users/profile-images/' + item.partner_avatar_url || default_avatar"
                    alt="avatar"
                    class="avatar"
                  />
                </div>
                <div class="conversation-info">
                  <div class="conversation-top">
                    <span class="name">{{ item.partner_name }}</span>
                    <span class="time">
                      {{ item.last_time | date:'dd/MM HH:mm' }}
                    </span>
                  </div>
                  <div class="conversation-bottom">
                    <span class="last-message">
                      {{ item.last_message || 'Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán' }}
                    </span>
                    @if ((item.unread_count ?? 0) > 0) {
                      <span
                        class="badge-unread">{{ (item.unread_count ?? 0) > 9 ? '9+' : (item.unread_count ?? 0) }}</span>
                    }
                  </div>
                </div>
              </li>
            }
          </ul>
        }
      }
    </div>
  </aside>

  <!-- üí¨ C·ªôt ph·∫£i: Chat -->
  <section class="chat-main">
    @if (!active_partner) {
      <div class="chat-empty">
        <h3>Ch·ªçn m·ªôt ng∆∞·ªùi b·∫°n ƒë·ªÉ tr√≤ chuy·ªán</h3>
        <p>H√£y ch·ªçn m·ªôt ng∆∞·ªùi ·ªü danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu chat 1-1.</p>
      </div>
    } @else {

      <!-- Header -->
      <header class="chat-header">
        <div class="partner-info">
          <img
            [src]="active_partner.partner_avatar_url || default_avatar"
            alt="avatar"
            class="avatar"
          />
          <div>
            <div class="name">{{ active_partner.partner_name }}</div>
            <div class="hint">ƒê√£ l√† b·∫°n b√® ‚Ä¢ Chat 1-1</div>
          </div>
        </div>
      </header>

      <!-- Danh s√°ch message -->
      <div class="chat-messages" #messagesContainer>
        @if (messages_loading && messages.length === 0) {
          <div class="messages-loading">ƒêang t·∫£i tin nh·∫Øn...</div>
        } @else {
          @if (messages_has_more && !messages_loading) {
            <button class="load-more-messages" (click)="load_more_messages()">
              T·∫£i th√™m tin nh·∫Øn c≈©
            </button>
          }
          @if (messages_loading && messages.length > 0) {
            <div class="messages-loading-more">ƒêang t·∫£i th√™m...</div>
          }

          @for (m of messages; track m.tin_nhan_id) {
            <div
              class="message-row"
              [class.mine]="m.la_toi"
            >
              <div class="message-bubble">
                <div class="message-text">
                  {{ m.noi_dung }}
                </div>
                <div class="message-time">
                  {{ m.gui_luc | date:'dd/MM HH:mm' }}
                </div>
              </div>
            </div>
          }

          @if (messages.length === 0 && !messages_loading) {
            <div class="messages-empty">
              Ch∆∞a c√≥ tin nh·∫Øn n√†o, h√£y g·ª≠i l·ªùi ch√†o üëã
            </div>
          }
        }
      </div>
      <!-- Input -->
      <footer class="chat-input">
        <textarea
          [(ngModel)]="new_message_noi_dung"
          placeholder="Nh·∫≠p tin nh·∫Øn..."
          (keydown.enter)="on_enter_send($any($event))"
        ></textarea>
        <button
          class="btn-send"
          (click)="send_message()"
          [disabled]="sending || !new_message_noi_dung.trim()"
        >
          G·ª≠i
        </button>
      </footer>
    }
  </section>
</div>
