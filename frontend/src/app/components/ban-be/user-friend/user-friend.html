<div class="social-page">
  <div class="bg-decor-1"></div>
  <div class="bg-decor-2"></div>

  <div class="social-container">

    <header class="social-header animate-fade-down">
      <div class="header-left">
        <div class="icon-box">ü§ù</div>
        <div class="text-group">
          <h1>S·∫£nh K·∫øt N·ªëi</h1>
          <p>T√¨m ki·∫øm ƒë·ªìng ƒë·ªôi, m·ªü r·ªông v√≤ng tr√≤n tri th·ª©c</p>
        </div>
      </div>

      <div class="add-friend-bar">
        <div class="input-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input type="text" [(ngModel)]="search_keyword"
            placeholder="T√¨m ki·∫øm ng∆∞·ªùi ch∆°i theo t√™n..."
            (keyup.enter)="searchUsers()">
        </div>
        <button class="btn-add" [disabled]="loading_search"
          (click)="searchUsers()">
          @if (loading_search) {
          <i class="fas fa-spinner fa-spin"></i>
          } @else {
          <i class="fas fa-search"></i> T√¨m ki·∫øm
          }
        </button>
      </div>
    </header>

    <div class="nav-tabs animate-fade-up">
      <button class="tab-pill"
        [class.active]="active_tab === 'friends'"
        (click)="setTab('friends')">
        <i class="fas fa-users"></i> B·∫°n b√® <span class="count">{{
          friends.length }}</span>
      </button>
      <button class="tab-pill"
        [class.active]="active_tab === 'incoming'"
        (click)="setTab('incoming')">
        <i class="fas fa-inbox"></i> L·ªùi m·ªùi ƒë·∫øn
        @if (incoming_requests.length > 0) {
        <span class="badge-red">{{ incoming_requests.length }}</span>
        }
      </button>
      <button class="tab-pill"
        [class.active]="active_tab === 'outgoing'"
        (click)="setTab('outgoing')">
        <i class="fas fa-paper-plane"></i> ƒê√£ g·ª≠i <span
          class="count">{{ outgoing_requests.length }}</span>
      </button>
      <button class="tab-pill"
        [class.active]="active_tab === 'suggestions'"
        (click)="setTab('suggestions')">
        <i class="fas fa-lightbulb"></i> G·ª£i √Ω
        @if (suggestions.length > 0) {
        <span class="badge-green">{{ suggestions.length }}</span>
        }
      </button>
      <button class="tab-pill"
        [class.active]="active_tab === 'search'"
        (click)="setTab('search')">
        <i class="fas fa-search"></i> T√¨m ki·∫øm
      </button>
      <button class="tab-pill"
        [class.active]="active_tab === 'blocked'"
        (click)="setTab('blocked')">
        <i class="fas fa-ban"></i> ƒê√£ ch·∫∑n
      </button>
    </div>

    <div class="content-area animate-scale-up">

      @if (loading_friends || loading_incoming || loading_outgoing) {
      <div class="loading-state">
        <div class="spinner-3d"></div>
        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
      </div>
      } @else {

      @if (active_tab === 'friends') {
      @if (friends.length === 0) {
      <div class="empty-state">
        <img src="assets/images/empty-friends.png"
          onerror="this.style.display='none'">
        <p>Danh s√°ch b·∫°n b√® ƒëang tr·ªëng. H√£y k·∫øt th√™m b·∫°n m·ªõi nh√©!</p>
      </div>
      } @else {
      <div class="grid-layout">
        @for (f of friends; track f.user_id) {
        <div class="user-card friend-card">
          <div class="status-dot"
            [class.online]="f.trang_thai === 'ONLINE'"></div>

          <div class="card-avatar">
            <img [src]="getAvatar(f.avatar_url, f.ho_ten)">
          </div>

          <div class="card-info">
            <h3>{{ f.ho_ten }}</h3>
            <div class="sub-info">
              <span class="uid">ID: {{ f.user_id }}</span>
              <span class="status-text"
                [class.on]="f.trang_thai === 'ONLINE'">
                {{ f.trang_thai === 'ONLINE' ? 'Online' : 'Offline' }}
              </span>
            </div>
          </div>

          <div class="card-actions">
            <button class="btn-icon chat" title="Nh·∫Øn tin"
              (click)="navigateChatWithFriend(f)">
              <i class="fas fa-comment-dots"></i>
            </button>
            <button class="btn-icon remove" (click)="unfriend(f)"
              title="H·ªßy k·∫øt b·∫°n">
              <i class="fas fa-user-minus"></i>
            </button>
          </div>
        </div>
        }
      </div>
      }
      }

      @if (active_tab === 'incoming') {
      @if (incoming_requests.length === 0) {
      <div class="empty-state">
        <p>Kh√¥ng c√≥ l·ªùi m·ªùi k·∫øt b·∫°n n√†o.</p>
      </div>
      } @else {
      <div class="grid-layout">
        @for (req of incoming_requests; track req.request_id) {
        <div class="user-card request-card">
          <div class="card-avatar">
            <img [src]="getAvatar(null, req.nguoi_gui_ten)">
          </div>
          <div class="card-info">
            <h3>{{ req.nguoi_gui_ten }}</h3>
            <span class="time-ago">G·ª≠i l√∫c: {{ req.tao_luc |
              date:'dd/MM HH:mm' }}</span>
          </div>
          <div class="action-row">
            <button class="btn-pill accept"
              (click)="acceptRequest(req)">Ch·∫•p nh·∫≠n</button>
            <button class="btn-pill decline"
              (click)="declineRequest(req)">X√≥a</button>
          </div>
        </div>
        }
      </div>
      }
      }

      @if (active_tab === 'outgoing') {
      @if (outgoing_requests.length === 0) {
      <div class="empty-state">
        <p>B·∫°n ch∆∞a g·ª≠i l·ªùi m·ªùi n√†o.</p>
      </div>
      } @else {
      <div class="grid-layout">
        @for (req of outgoing_requests; track req.request_id) {
        <div class="user-card sent-card">
          <div class="card-avatar grayscale">
            <img [src]="getAvatar(null, req.nguoi_nhan_ten)">
          </div>
          <div class="card-info">
            <h3>{{ req.nguoi_nhan_ten }}</h3>
            <span class="time-ago">ƒê√£ g·ª≠i: {{ req.tao_luc |
              date:'dd/MM HH:mm' }}</span>
            <span class="status-badge pending">ƒêang ch·ªù...</span>
          </div>
          <div class="card-actions">
            <button class="btn-text cancel"
              (click)="cancelRequest(req)">
              <i class="fas fa-times"></i> H·ªßy l·ªùi m·ªùi
            </button>
          </div>
        </div>
        }
      </div>
      }
      }

      <!-- ============== TAB G·ª¢I √ù ============== -->
      @if (active_tab === 'suggestions') {
      @if (loading_suggestions) {
      <div class="loading-state">
        <div class="spinner-3d"></div>
        <p>ƒêang t√¨m g·ª£i √Ω...</p>
      </div>
      } @else if (suggestions.length === 0) {
      <div class="empty-state">
        <p>Kh√¥ng c√≥ g·ª£i √Ω k·∫øt b·∫°n n√†o. H√£y tham gia th√™m tr·∫≠n ƒë·∫•u!</p>
      </div>
      } @else {
      <div class="grid-layout">
        @for (user of suggestions; track user.user_id) {
        <div class="user-card suggestion-card">
          <div class="suggestion-reason">
            <i class="fas" [ngClass]="getReasonIcon(user.reason)"></i>
            {{ getReasonLabel(user.reason) }}
            @if (user.mutual_friends_count > 0) {
            <span class="mutual-count">({{ user.mutual_friends_count
              }})</span>
            }
          </div>
          <div class="card-avatar">
            <img [src]="getAvatar(user.avatar_url, user.ho_ten)">
          </div>
          <div class="card-info">
            <h3>{{ user.ho_ten }}</h3>
            <div class="sub-info">
              <span class="level">Lv.{{ user.level }}</span>
              <span class="points">{{ user.tong_diem | number }}
                ƒëi·ªÉm</span>
            </div>
          </div>
          <div class="card-actions">
            <button class="btn-pill accept"
              [disabled]="isSendingRequest(user.user_id)"
              (click)="sendRequestFromSuggestion(user)">
              @if (isSendingRequest(user.user_id)) {
              <i class="fas fa-spinner fa-spin"></i>
              } @else {
              <i class="fas fa-user-plus"></i> K·∫øt b·∫°n
              }
            </button>
          </div>
        </div>
        }
      </div>
      }
      }

      <!-- ============== TAB T√åM KI·∫æM ============== -->
      @if (active_tab === 'search') {
      <div class="search-section">
        <div class="search-input-large">
          <i class="fas fa-search"></i>
          <input type="text" [(ngModel)]="search_keyword"
            placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i..."
            (keyup.enter)="searchUsers()">
          <button class="btn-search" [disabled]="loading_search"
            (click)="searchUsers()">
            @if (loading_search) {
            <i class="fas fa-spinner fa-spin"></i>
            } @else {
            T√¨m
            }
          </button>
        </div>
      </div>

      @if (loading_search) {
      <div class="loading-state">
        <div class="spinner-3d"></div>
        <p>ƒêang t√¨m ki·∫øm...</p>
      </div>
      } @else if (search_results.length === 0 && search_keyword) {
      <div class="empty-state">
        <p>Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i n√†o v·ªõi t·ª´ kh√≥a "{{
          search_keyword }}"</p>
      </div>
      } @else if (search_results.length > 0) {
      <div class="grid-layout">
        @for (user of search_results; track user.user_id) {
        <div class="user-card search-card">
          <div class="status-dot"
            [class.online]="user.trang_thai === 'ONLINE'"></div>
          <div class="card-avatar">
            <img [src]="getAvatar(user.avatar_url, user.ho_ten)">
          </div>
          <div class="card-info">
            <h3>{{ user.ho_ten }}</h3>
            <div class="sub-info">
              <span class="uid">ID: {{ user.user_id }}</span>
              <span class="status-text"
                [class.on]="user.trang_thai === 'ONLINE'">
                {{ user.trang_thai === 'ONLINE' ? 'Online' : 'Offline'
                }}
              </span>
            </div>
          </div>
          <div class="card-actions">
            <button class="btn-pill accept"
              [disabled]="isSendingRequest(user.user_id)"
              (click)="sendRequestFromSearch(user)">
              @if (isSendingRequest(user.user_id)) {
              <i class="fas fa-spinner fa-spin"></i>
              } @else {
              <i class="fas fa-user-plus"></i> K·∫øt b·∫°n
              }
            </button>
          </div>
        </div>
        }
      </div>
      } @else {
      <div class="empty-state">
        <p>Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i v√† nh·∫•n "T√¨m" ƒë·ªÉ t√¨m ki·∫øm</p>
      </div>
      }
      }

      <!-- ============== TAB ƒê√É CH·∫∂N ============== -->
      @if (active_tab === 'blocked') {
      @if (loading_blocked) {
      <div class="loading-state">
        <div class="spinner-3d"></div>
        <p>ƒêang t·∫£i...</p>
      </div>
      } @else if (blocked_users.length === 0) {
      <div class="empty-state">
        <p>B·∫°n ch∆∞a ch·∫∑n ai.</p>
      </div>
      } @else {
      <div class="grid-layout">
        @for (blocked of blocked_users; track blocked.block_id) {
        <div class="user-card blocked-card">
          <div class="card-avatar grayscale">
            <img
              [src]="getAvatar(blocked.avatar_url, blocked.ho_ten)">
          </div>
          <div class="card-info">
            <h3>{{ blocked.ho_ten }}</h3>
            <span class="time-ago">Ch·∫∑n l√∫c: {{ blocked.chan_luc |
              date:'dd/MM/yyyy HH:mm' }}</span>
            @if (blocked.ly_do) {
            <span class="block-reason">L√Ω do: {{ blocked.ly_do
              }}</span>
            }
          </div>
          <div class="card-actions">
            <button class="btn-pill unblock"
              (click)="unblockUser(blocked)">
              <i class="fas fa-unlock"></i> B·ªè ch·∫∑n
            </button>
          </div>
        </div>
        }
      </div>
      }
      }

      }
    </div>
  </div>
</div>