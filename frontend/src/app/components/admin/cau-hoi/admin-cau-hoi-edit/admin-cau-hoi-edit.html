@if (!loading) {
  <div class="question-page animate-fade-down">
    <div class="question-container">

      <header class="page-header">
        <div class="header-left">
          <button class="btn-back" (click)="backToBoCauHoiDetail()">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i
          </button>
          <h1>Ch·ªânh S·ª≠a C√¢u H·ªèi</h1>
        </div>
      </header>

      <form #form="ngForm" (ngSubmit)="onSubmit(form)" class="form-card" autocomplete="off">

        <div class="form-section">
          <h3 class="section-title"><i class="fas fa-layer-group"></i> 1. N·ªôi dung & Media</h3>

          <div class="form-group">
            <label>Lo·∫°i n·ªôi dung</label>
            <div class="type-selector">
              <button type="button" class="type-btn" [class.active]="model.loai_noi_dung === 'VAN_BAN'"
                      (click)="setMediaType('VAN_BAN')">
                <i class="fas fa-font"></i> VƒÉn b·∫£n
              </button>
              <button type="button" class="type-btn" [class.active]="model.loai_noi_dung === 'HINH_ANH'"
                      (click)="setMediaType('HINH_ANH')">
                <i class="fas fa-image"></i> H√¨nh ·∫£nh
              </button>
              <button type="button" class="type-btn" [class.active]="model.loai_noi_dung === 'AM_THANH'"
                      (click)="setMediaType('AM_THANH')">
                <i class="fas fa-volume-up"></i> √Çm thanh
              </button>
              <button type="button" class="type-btn" [class.active]="model.loai_noi_dung === 'VIDEO'"
                      (click)="setMediaType('VIDEO')">
                <i class="fas fa-video"></i> Video
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>N·ªôi dung c√¢u h·ªèi <span class="required">*</span></label>
            <textarea [(ngModel)]="model.noi_dung" name="noi_dung" rows="3" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
                      class="form-textarea" required></textarea>
          </div>

          @if (model.loai_noi_dung !== 'VAN_BAN') {
            <div class="upload-zone" [class.has-file]="previewUrl">
              @if (!previewUrl) {
                <div class="upload-placeholder" (click)="fileInput.click()">
                  <i class="fas fa-cloud-upload-alt upload-icon"></i>
                  <p>K√©o th·∫£ ho·∫∑c <span>nh·∫•n ƒë·ªÉ thay ƒë·ªïi file</span></p>
                  <span class="sub-text">H·ªó tr·ª£: JPG, PNG, MP3, MP4</span>
                </div>
              } @else {
                <div class="media-preview-box">
                  @switch (model.loai_noi_dung) {
                    @case ('HINH_ANH') {
                      <img [src]="previewUrl" class="preview-img" alt="Preview Image">
                    }
                    @case ('AM_THANH') {
                      <audio controls [src]="previewUrl" class="preview-audio"></audio>
                    }
                    @case ('VIDEO') {
                      <video controls [src]="previewUrl" class="preview-video"></video>
                    }
                  }
                  <div class="media-actions">
                    <button type="button" class="btn-change-media" (click)="fileInput.click()">
                      <i class="fas fa-sync"></i> ƒê·ªïi file
                    </button>
                  </div>
                </div>
              }
              <input #fileInput type="file" hidden (change)="onFileSelected($event)" accept="image/*,audio/*,video/*">
            </div>
          }
        </div>

        <div class="divider"></div>

        <div class="form-section">
          <h3 class="section-title"><i class="fas fa-list-check"></i> 2. L·ª±a ch·ªçn ƒë√°p √°n</h3>
          <p class="section-desc">Nh·∫≠p n·ªôi dung cho 4 ƒë√°p √°n v√† ch·ªçn ƒë√°p √°n ƒë√∫ng.</p>

          <div class="answers-grid">
            @for (opt of luaChonList; track opt) {
              <div class="answer-card" [class.correct]="model.dap_an_dung === opt">
                <div class="card-header" (click)="model.dap_an_dung = opt">
                  <div class="radio-circle">
                    <span class="opt-char">{{ opt }}</span>
                    <i class="fas fa-check check-icon"></i>
                  </div>
                  <span class="status-text">{{ model.dap_an_dung === opt ? 'ƒê√°p √°n ƒë√∫ng' : 'Sai' }}</span>
                </div>
                <div class="card-body">
                  <input type="text" [(ngModel)]="model['lua_chon_' + opt.toLowerCase()]"
                         name="lua_chon_{{opt}}"
                         placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi {{opt}}..."
                         class="ans-input" required>
                </div>
              </div>
            }
          </div>
        </div>

        <div class="divider"></div>

        <div class="form-section">
          <h3 class="section-title"><i class="fas fa-sliders-h"></i> 3. C·∫•u h√¨nh b·ªï sung</h3>

          <div class="config-row">
            <div class="form-group flex-2">
              <label>Gi·∫£i th√≠ch chi ti·∫øt</label>
              <textarea [(ngModel)]="model.giai_thich" name="giai_thich" rows="2"
                        placeholder="T·∫°i sao ƒë√°p √°n n√†y ƒë√∫ng?..." class="form-textarea"></textarea>
            </div>

            <div class="form-group flex-1">
              <label>ƒê·ªô kh√≥</label>
              <select [(ngModel)]="model.do_kho" name="do_kho" class="form-select">
                <option value="DE">üü¢ D·ªÖ</option>
                <option value="TRUNG_BINH">üü° Trung b√¨nh</option>
                <option value="KHO">üî¥ Kh√≥</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-footer">
          <button type="button" class="btn-cancel" (click)="backToBoCauHoiDetail()">H·ªßy b·ªè</button>
          <button type="submit" class="btn-submit" [disabled]="saving || form.invalid">
            @if (saving) {
              <i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...
            } @else {
              <i class="fas fa-save"></i> L∆∞u thay ƒë·ªïi
            }
          </button>
        </div>

      </form>
    </div>
  </div>
} @else {
  <div class="loading-state">
    <div class="spinner"></div>
    ƒêang t·∫£i d·ªØ li·ªáu...
  </div>
}
