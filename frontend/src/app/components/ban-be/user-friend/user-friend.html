<div class="user-friend-page">

  <h2 class="page-title">Kết bạn & danh sách bạn bè</h2>
  <p class="page-subtitle">
    Quản lý bạn bè, lời mời kết bạn đến và các lời mời bạn đã gửi.
  </p>

  <!-- Thanh tabs -->
  <div class="tabs">
    <button
      class="tab-btn"
      [class.active]="active_tab === 'friends'"
      (click)="setTab('friends')">
      Bạn bè
    </button>
    <button
      class="tab-btn"
      [class.active]="active_tab === 'incoming'"
      (click)="setTab('incoming')">
      Lời mời đến
    </button>
    <button
      class="tab-btn"
      [class.active]="active_tab === 'outgoing'"
      (click)="setTab('outgoing')">
      Lời mời đã gửi
    </button>
  </div>

  <!-- Ô gửi lời mời nhanh -->
  <section class="card quick-add">
    <div class="quick-add-title">Gửi lời mời nhanh theo User ID</div>
    <div class="quick-add-row">
      <input
        type="number"
        min="1"
        class="input"
        [(ngModel)]="new_friend_id"
        placeholder="Nhập user ID..."
      />
      <button
        class="btn-primary"
        [disabled]="sending_request"
        (click)="sendFriendRequest()">
        {{ sending_request ? 'Đang gửi...' : 'Gửi lời mời' }}
      </button>
    </div>
    <div class="quick-add-hint">
      (Tạm thời dùng theo user_id. Sau này có trang tìm kiếm người dùng / profile, mình sẽ gắn nút "Kết bạn" trực tiếp.)
    </div>
  </section>

  <!-- TAB: Bạn bè -->
  @if (active_tab === 'friends') {
    <section class="card">
      <h3>Danh sách bạn bè</h3>

      @if (loading_friends) {
        <div class="loading">Đang tải danh sách bạn bè...</div>
      } @else {
        @if (friends.length === 0) {
          <div class="empty">
            Bạn chưa có người bạn nào. Hãy thử gửi lời mời kết bạn.
          </div>
        } @else {
          <table class="table">
            <thead>
            <tr>
              <th>Họ tên</th>
              <th>Trạng thái</th>
              <th>Hành động</th>
            </tr>
            </thead>
            <tbody>
              @for (f of friends; track f.user_id) {
                <tr>
                  <td>
                    {{ f.ho_ten }}
                  </td>
                  <td>
                    <span class="badge"
                          [class.badge-online]="f.trang_thai === 'ONLINE'"
                          [class.badge-offline]="f.trang_thai !== 'ONLINE'">
                      {{ f.trang_thai === 'ONLINE' ? 'Đang online' : 'Offline' }}
                    </span>
                  </td>
                  <td>
                    <button class="btn-danger" (click)="unfriend(f)">
                      Huỷ kết bạn
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      }
    </section>
  }

  <!-- TAB: Lời mời đến -->
  @if (active_tab === 'incoming') {
    <section class="card">
      <h3>Lời mời kết bạn đến</h3>

      @if (loading_incoming) {
        <div class="loading">Đang tải lời mời đến...</div>
      } @else {
        @if (incoming_requests.length === 0) {
          <div class="empty">
            Hiện bạn không có lời mời kết bạn nào.
          </div>
        } @else {
          <table class="table">
            <thead>
            <tr>
              <th>Người gửi</th>
              <th>Thời gian</th>
              <th>Hành động</th>
            </tr>
            </thead>
            <tbody>
              @for (req of incoming_requests; track req.request_id) {
                <tr>
                  <td>{{ req.nguoi_gui_ten }}</td>
                  <td>{{ req.tao_luc | date:'dd/MM/yyyy HH:mm' }}</td>
                  <td>
                    <button class="btn-primary" (click)="acceptRequest(req)">
                      Chấp nhận
                    </button>
                    <button class="btn-secondary" (click)="declineRequest(req)">
                      Từ chối
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      }
    </section>
  }

  <!-- TAB: Lời mời đã gửi -->
  @if (active_tab === 'outgoing') {
    <section class="card">
      <h3>Lời mời kết bạn đã gửi</h3>

      @if (loading_outgoing) {
        <div class="loading">Đang tải lời mời đã gửi...</div>
      } @else {
        @if (outgoing_requests.length === 0) {
          <div class="empty">
            Bạn chưa gửi lời mời kết bạn nào.
          </div>
        } @else {
          <table class="table">
            <thead>
            <tr>
              <th>Người nhận</th>
              <th>Thời gian</th>
              <th>Trạng thái</th>
              <th>Hành động</th>
            </tr>
            </thead>
            <tbody>
              @for (req of outgoing_requests; track req.request_id) {
                <tr>
                  <td>{{ req.nguoi_nhan_ten }}</td>
                  <td>{{ req.tao_luc }}</td>
                  <td>{{ req.trang_thai }}</td>
                  <td>
                    @if (req.trang_thai === 'PENDING') {
                      <button class="btn-secondary" (click)="cancelRequest(req)">
                        Huỷ lời mời
                      </button>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      }
    </section>
  }

</div>
