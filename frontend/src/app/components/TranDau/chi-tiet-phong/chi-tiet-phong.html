@if (!loading()) {
  <div class="page">
    <div class="container">
      <header class="header">
        <div class="title">
          <h1>{{ pageTitle() }}</h1>
          <span class="code">#{{ battle()?.ma_phong }}</span>
          <span [class]="badgeClass(status())">{{ status() }}</span>
        </div>
        <div class="meta">
          <div>
            <strong>Ch·∫ø ƒë·ªô:</strong>
            <span>{{ battle()?.cong_khai ? 'C√¥ng khai' : 'Ri√™ng t∆∞' }}</span>

            @if (!battle()?.cong_khai) {
              ‚Äî <em>Y√™u c·∫ßu PIN</em>
            }
          </div>
          <div>
            <strong>B·ªô c√¢u h·ªèi:</strong>
            {{ battle()?.bo_cau_hoi_tieu_de || ('#' + battle()?.bo_cau_hoi_id) }}
          </div>
          <div>
            <strong>Gi·ªõi h·∫°n ng∆∞·ªùi ch∆°i:</strong> {{ battle()?.gioi_han_nguoi_choi }}
          </div>
          <div>
            <strong>Th·ªùi gian m·ªói c√¢u:</strong>
            {{ battle()?.gioi_han_thoi_gian_cau_giay }} gi√¢y ‚Äî
            <strong>Lu·∫≠t ƒëi·ªÉm:</strong> {{ battle()?.luat_tinh_diem }}
          </div>
        </div>
      </header>

      <section class="actions">
        <div class="left">
          <button class="btn" (click)="doSync()" [disabled]="saving()">ƒê·ªìng b·ªô</button>
          @if (battle()?.chu_phong_ten === currentUserName()) {
            <button
              class="btn primary"
              (click)="startBattle()"
              [disabled]="!isPending() || saving() || !isJoined()"
              [title]="!isJoined() ? 'B·∫°n c·∫ßn b·∫•m Tham Gia tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu' : ''"
            >
              B·∫Øt ƒë·∫ßu
            </button>

            <button
              class="btn warn"
              (click)="finishBattle()"
              [disabled]="!isOngoing() || saving() || !isJoined()"
            >
              K·∫øt th√∫c
            </button>

            <button
              class="btn"
              (click)="open_invite_panel()"
              [disabled]="saving() || !isPending()"
            >
              M·ªùi b·∫°n b√®
            </button>
          }
          <button class="btn ghost" (click)="leave()" [disabled]="saving()">R·ªùi ph√≤ng</button>
        </div>

        @if (!isJoined()) {
          @if (!battle()?.cong_khai && isPending()) {
            <div class="right">
              <input
                class="pin"
                placeholder="Nh·∫≠p PIN ƒë·ªÉ v√†o"
                [ngModel]="pinCode()"
                (ngModelChange)="pinCode.set($event)"
              />
              <button class="btn" (click)="join()" [disabled]="saving() || !pinCode()">
                Nh·∫≠p m√£ pin & Tham gia
              </button>
            </div>
          } @else if (battle()?.cong_khai && isPending()) {
            <div class="right">
              <button class="btn" (click)="join()" [disabled]="saving()">Tham gia ngay</button>
            </div>
          }
        } @else {
          <div class="right joined-status">
       <span class="status-text">
         <i class="fas fa-check-circle"></i> B·∫°n ƒë√£ tham gia
       </span>
          </div>
        }
      </section>

      <!-- ================== OVERLAY COUNTDOWN CHU·∫®N B·ªä (N·∫æU C√ì) ================== -->
      @if (preCountdown() > 0 && !showSummary()) {
        <div class="pre-countdown-overlay">
          <div class="pre-countdown-card">
            <div class="label">Tr·∫≠n ƒë·∫•u s·∫Øp b·∫Øt ƒë·∫ßu</div>
            <div class="number">{{ preCountdown() }}</div>
            <p>H√£y s·∫µn s√†ng cho c√¢u h·ªèi ƒë·∫ßu ti√™n!</p>
          </div>
        </div>
      }
      @if (showSummary()) {
        <div class="summary-screen">

          <header class="summary-header">
            <h2>B·∫¢NG X·∫æP H·∫†NG</h2>
            <p>{{ battle()?.bo_cau_hoi_tieu_de }}</p>
          </header>

          <div class="podium-stage">

            <div class="podium-item rank-2" [class.empty]="!topThree[1]">
              <div class="avatar-box">
                <img [src]="'http://localhost:8088/api/v1/users/profile-images/' + topThree[1]?.avatar_url"
                     class="avatar">
                <span class="badge">2</span>
              </div>
              <div class="p-name">{{ topThree[1]?.ho_ten || '---' }}</div>
              <div class="p-score">{{ topThree[1]?.diem || 0 }}</div>
              <div class="podium-bar"></div>
            </div>

            <div class="podium-item rank-1" [class.empty]="!topThree[0]">
              <div class="crown-icon">üëë</div>
              <div class="avatar-box">
                <img [src]="'http://localhost:8088/api/v1/users/profile-images/' + topThree[0]?.avatar_url"
                     class="avatar">
                <span class="badge">1</span>
              </div>
              <div class="p-name">{{ topThree[0]?.ho_ten || '---' }}</div>
              <div class="p-score">{{ topThree[0]?.diem || 0 }}</div>
              <div class="podium-bar"></div>
            </div>

            <div class="podium-item rank-3" [class.empty]="!topThree[2]">
              <div class="avatar-box">
                <img [src]="'http://localhost:8088/api/v1/users/profile-images/' + topThree[2]?.avatar_url"
                     class="avatar">
                <span class="badge">3</span>
              </div>
              <div class="p-name">{{ topThree[2]?.ho_ten || '---' }}</div>
              <div class="p-score">{{ topThree[2]?.diem || 0 }}</div>
              <div class="podium-bar"></div>
            </div>

          </div>

          @if (restPlayers.length > 0) {
            <div class="rest-list">
              @for (p of restPlayers; track p.user_id) {
                <div class="list-item" [class.me]="p.user_id === userService.getUserId()">
                  <div class="rank-num">#{{ p.xep_hang }}</div>
                  <img [src]="getAvatarUrl(p.user_id)" class="list-avatar">
                  <div class="list-name">{{ p.ho_ten }}</div>
                  <div class="list-score">{{ p.diem }} ƒëi·ªÉm</div>
                </div>
              }
            </div>
          }

          <div class="summary-footer">
            <button class="btn-action secondary" (click)="goBackHome()">
              <i class="fas fa-home"></i> Trang ch·ªß
            </button>

            <button class="btn-action primary" (click)="practiceThisSet()">
              <i class="fas fa-redo"></i> Luy·ªán t·∫≠p l·∫°i
            </button>

            <button class="btn-action outline" (click)="goBackToBattleList()">
              <i class="fas fa-list"></i> Danh s√°ch ph√≤ng
            </button>
          </div>

        </div>
      } @else {
        <div class="game-layout">
          <div class="game-main">
            @if (syncState(); as s) {
              <section class="play">
                <h3>Tr·∫°ng th√°i hi·ªán t·∫°i</h3>
                <div class="grid">
                  <div class="cell">
                    <div class="label">C√¢u hi·ªán t·∫°i</div>
                    <div class="value">{{ s.current_question_index >= 0 ? s.current_question_index + 1 : '‚Äî' }}</div>
                  </div>
                  <div class="cell">
                    <div class="label">ƒêi·ªÉm c·ªßa b·∫°n</div>
                    <div class="value highlight">{{ s.my_total_points }}</div>
                  </div>
                  <div class="cell">
                    <div class="label">ƒê·∫øm ng∆∞·ª£c</div>
                    <div class="value countdown">
                      {{ remainingSeconds() > 0 ? remainingSeconds() + 's' : '0s' }}
                    </div>
                  </div>
                  <div class="cell">
                    <div class="label">Combo hi·ªán t·∫°i</div>
                    <div class="value combo-value"
                         [class.hot]="currentCombo() >= 3 && currentCombo() < 5"
                         [class.insane]="currentCombo() >= 5">
                      @if (currentCombo() >= 2) {
                        <span>üî• x{{ currentCombo() }}</span>
                      } @else {
                        <span>‚Äî</span>
                      }
                    </div>
                  </div>
                </div>

                @if (s.current_question_index >= 0) {
                  <div class="question-block" [attr.data-question-id]="s.current_question_id"
                       [attr.data-version]="s._version">
                    <div class="question">{{ s.noi_dung }}</div>

                    @if (s.duong_dan_tep && s.loai_noi_dung !== 'VAN_BAN') {
                      @switch (s.loai_noi_dung) {
                        @case ('HINH_ANH') {
                          <div class="media">
                            <img
                              [src]="environment.apiBaseUrl + '/cauHoi/media/' + s.duong_dan_tep + '?v=' + s._version"
                              alt="img"/>
                          </div>
                        }
                        @case ('AM_THANH') {
                          <div class="media">
                            <audio controls
                                   [src]="environment.apiBaseUrl + '/cauHoi/media/' + s.duong_dan_tep + '?v=' + s._version"></audio>
                          </div>
                        }
                        @case ('VIDEO') {
                          <div class="media">
                            <video controls
                                   [src]="environment.apiBaseUrl + '/cauHoi/media/' + s.duong_dan_tep + '?v=' + s._version"></video>
                          </div>
                        }
                      }
                    }
                    <div class="choices" [class.long-layout]="hasLongAnswer()">
                      @for (opt of ['A', 'B', 'C', 'D']; track $index) {
                        <button
                          class="choice"
                          [class.active]="selectedAnswer() === opt"
                          [class.correct]="revealedCorrectAnswer() === opt"
                          [class.incorrect]="revealedCorrectAnswer() && selectedAnswer() === opt && revealedCorrectAnswer() !== opt"
                          (click)="selectAnswer(opt)"
                          [disabled]="saving() || submittedCurrentAnswer() || remainingSeconds() <= 0 || !!revealedCorrectAnswer()"
                        >
                          <div class="choice-content">
                            <strong>{{ opt }}.</strong>
                            <span>{{ opt === 'A' ? s.a : opt === 'B' ? s.b : opt === 'C' ? s.c : opt === 'D' ? s.d : '' }}</span>
                          </div>

                          @if (revealedCorrectAnswer()) {
                            @if (revealedCorrectAnswer() === opt) {
                              <i class="fas fa-check-circle status-icon"></i>
                            } @else if (selectedAnswer() === opt) {
                              <i class="fas fa-times-circle status-icon"></i>
                            }
                          }
                        </button>
                      }
                    </div>

                    @if (submittedCurrentAnswer() && !revealedCorrectAnswer()) {
                      <div class="hint animate-pulse">
                        <i class="fas fa-check-circle"></i>
                        ƒê√£ g·ª≠i ƒë√°p √°n. Vui l√≤ng ƒë·ª£i c√¢u h·ªèi k·∫ø ti·∫øp...
                      </div>
                    }

                    @if (revealedCorrectAnswer() && revealedExplanation()) {
                      <div class="answer-reveal animate-fade-in">
                        <strong><i class="fas fa-lightbulb"></i> Gi·∫£i th√≠ch:</strong>
                        {{ revealedExplanation() }}
                      </div>
                    }

                    @if (!submittedCurrentAnswer() && !revealedCorrectAnswer()) {
                      <div class="submit-row">
                        <button class="btn primary" (click)="submitSelectedAnswer()"
                                [disabled]="saving() || !selectedAnswer()">
                          N·ªôp ƒë√°p √°n
                        </button>
                      </div>
                    }
                  </div>

                } @else {
                  <div class="waiting-state">
                    <i class="fas fa-hourglass-half"></i>
                    <p>Ch·ªù ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu c√¢u h·ªèi...</p>
                  </div>
                }
              </section>
            }
          </div>

          <div class="game-sidebar">
            @if (leaderboard().length > 0) {
              <section class="leaderboard">
                <h3><i class="fas fa-trophy"></i> Top X·∫øp h·∫°ng</h3>
                <table class="ranking">
                  <thead>
                  <tr>
                    <th>#</th>
                    <th>T√™n</th>
                    <th>ƒêi·ªÉm</th>
                    <th>ƒê√∫ng</th>
                  </tr>
                  </thead>
                  <tbody>
                    @for (p of leaderboard(); track p.user_id) {
                      <tr [class.left-player]="p.da_roi" [class.is-me]="p.user_id === finalResult?.myId">
                        <td>
                          <span class="rank-chip" [class.top1]="p.xep_hang === 1">{{ p.xep_hang }}</span>
                        </td>
                        <td>
                          {{ p.ho_ten }}
                          @if (p.da_roi) {
                            <span class="tag-left" style="font-size: 0.8em; color: #999;">(ƒë√£ r·ªùi)</span>
                          }
                        </td>
                        <td><strong>{{ p.diem }}</strong></td>
                        <td>{{ p.so_cau_dung }}</td>
                      </tr>
                    } @empty {
                      <tr>
                        <td colspan="4">Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng.</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </section>
            }

            <section class="chat-panel">
              <div class="chat-header">
                <h3>Chat Room</h3>
                <span class="online-badge">{{ onlineCount() }} online</span>
              </div>

              <div class="chat-messages" #scrollContainer>
                @for (m of chatMessages(); track $index) {
                  <div class="chat-row" [class.me]="m.is_me" [class.system]="m.is_system">

                    @if (!m.is_me && !m.is_system) {
                      <div class="avatar-container">
                        @if (avatarUrl) {
                          <img [src]="avatarUrl" alt="avt" class="avatar-img" (error)="m.avatar_url = ''">
                        } @else {
                          <div class="avatar-text" [style.background-color]="getAvatarColor(m.ho_ten)">
                            {{ m.ho_ten.charAt(0).toUpperCase() }}
                          </div>
                        }
                      </div>
                    }

                    <div class="msg-content">
                      @if (!m.is_me && !m.is_system) {
                        <div class="sender">{{ m.ho_ten }}</div>
                      }

                      <div class="bubble">
                        <span class="text">{{ m.noi_dung }}</span>
                        <span class="msg-time">{{ m.timestamp | date:'HH:mm' }}</span>
                      </div>
                    </div>
                  </div>
                } @empty {
                  <div class="chat-empty">
                    <div class="empty-icon">üí¨</div>
                    <p>S√†n ƒë·∫•u ƒëang im l·∫∑ng...<br>H√£y khu·∫•y ƒë·ªông phong tr√†o!</p>
                  </div>
                }
              </div>

              <div class="chat-input-area">
                @if (showEmojiPicker()) {
                  <div class="emoji-popup">
                    <emoji-mart [showPreview]="false" [enableSearch]="false"
                                (emojiClick)="addEmoji($event)"></emoji-mart>
                  </div>
                }

                <form class="input-box" (ngSubmit)="sendChat()">
                  <button type="button" class="btn-icon" (click)="toggleEmojiPicker()">üòÉ</button>
                  <input
                    type="text"
                    [ngModel]="chatInput()"
                    (ngModelChange)="chatInput.set($event)"
                    name="chatMsg"
                    placeholder="Nh·∫Øn tin..."
                    autocomplete="off"
                  >
                  <button type="submit" class="btn-send" [disabled]="!chatInput().trim()">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </form>
              </div>
            </section>

          </div>
        </div>
        @if (show_invite_panel) {
          <div class="invite-overlay" (click)="close_invite_panel()">
            <div class="invite-panel" (click)="$event.stopPropagation()">
              <header class="invite-header">
                <h3>M·ªùi b·∫°n b√® v√†o ph√≤ng</h3>
                <button class="btn-close" (click)="close_invite_panel()">
                  <i class="fas fa-times"></i>
                </button>
              </header>

              <div class="invite-body">
                @if (invite_loading) {
                  <div class="invite-empty">ƒêang t·∫£i danh s√°ch b·∫°n b√®...</div>
                } @else {
                  @if (invite_friends.length === 0) {
                    <div class="invite-empty">
                      B·∫°n ch∆∞a c√≥ b·∫°n b√® n√†o ƒë·ªÉ m·ªùi.
                    </div>
                  } @else {
                    <ul class="invite-list">
                      @for (f of invite_friends; track f.user_id) {
                        <li class="invite-item">
                          <div class="friend-info">
                            <img
                              [src]="build_friend_avatar(f.avatar_url)"
                              class="avatar"
                              alt="avatar"
                            />
                            <div class="friend-text">
                              <div class="name">{{ f.ho_ten }}</div>
                              <div class="status">
                                {{ f.trang_thai === 'ONLINE' ? 'ƒêang online' : 'Offline' }}
                              </div>
                            </div>
                          </div>

                          <button
                            class="btn small"
                            (click)="invite_friend_to_battle(f)"
                            [disabled]="is_inviting(f.user_id)"
                          >
                            @if (is_inviting(f.user_id)) {
                              ƒêang m·ªùi...
                            } @else {
                              M·ªùi
                            }
                          </button>
                        </li>
                      }
                    </ul>
                  }
                }
              </div>
            </div>
          </div>
        }

      }
    </div>
  </div>
} @else {
  <div class="loading">
    <i class="fas fa-spinner fa-spin"></i>
    ƒêang t·∫£i ph√≤ng...
  </div>
}
@if (showComboVFX) {
  <div class="combo-vfx">
    <div class="fire-text">COMBO!</div>
    <div class="combo-num">x{{ currentCombo() }}</div>
  </div>
}
