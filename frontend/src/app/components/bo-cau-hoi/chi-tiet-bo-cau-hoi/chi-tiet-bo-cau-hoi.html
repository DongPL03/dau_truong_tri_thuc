@if (!loading) {
<div class="detail-container">

  <header class="hero-card">
    <div class="hero-bg-decoration"></div>

    <div class="hero-content">
      <div class="hero-badges">
        <span class="topic-tag">{{ bo?.chu_de || 'General' }}</span>
        @if (bo?.trang_thai === 'DA_DUYET') {
        <span class="badge badge-approved"><i
            class="fas fa-check-circle"></i> Đã duyệt</span>
        } @else if (bo?.trang_thai === 'CHO_DUYET') {
        <span class="badge badge-pending"><i class="fas fa-clock"></i>
          Chờ duyệt</span>
        } @else if (bo?.trang_thai === 'TU_CHOI') {
        <span class="badge badge-rejected"><i class="fas fa-ban"></i>
          Từ chối</span>
        }

        <span class="badge badge-mode"
          [class.private]="bo?.che_do_hien_thi === 'PRIVATE'">
          <i class="fas"
            [ngClass]="bo?.che_do_hien_thi === 'PUBLIC' ? 'fa-globe' : 'fa-lock'"></i>
          {{ bo?.che_do_hien_thi }}
        </span>
      </div>

      <h1 class="quiz-title">{{ bo?.tieu_de || 'Đang tải tiêu đề...'
        }}</h1>
      <p class="quiz-desc">{{ bo?.mo_ta || 'Chưa có mô tả cho bộ câu
        hỏi này.' }}</p>

      @if (bo?.che_do_hien_thi === 'PUBLIC' && bo?.trang_thai ===
      'CHO_DUYET') {
      <div class="alert-box info">
        <i class="fas fa-info-circle"></i>
        <span>Bộ câu hỏi đang chờ Admin duyệt để công khai. Bạn vẫn có
          thể chỉnh sửa.</span>
      </div>
      }
    </div>

    <div class="hero-actions">
      <button class="btn-glass" (click)="navigateToDetaiList()">
        <i class="fas fa-arrow-left"></i> Quay lại
      </button>

      @if (!isLocked && (isOwner() || isAdmin())) {
      <button class="btn-3d-primary" (click)="goCreateQuestion()">
        <i class="fas fa-plus-circle"></i> Thêm câu hỏi
      </button>
      }
    </div>
  </header>

  @if (isLocked && !isOwner() && !isAdmin() && !isPreview) {
  <div class="locked-section">
    <div class="lock-icon-3d"><i class="fas fa-lock"></i></div>
    <h2>Nội dung này đã bị khóa!</h2>
    <p class="lock-msg">{{ unlockError || 'Bạn cần mở khóa để xem chi
      tiết bộ câu hỏi này.' }}</p>

    <div class="unlock-price-tag">
      <span>Giá mở khóa</span>
      <strong>{{ bo?.gia_mo_khoa || 0 }} <i
          class="fas fa-coins"></i></strong>
    </div>

    <button class="btn-unlock-big" (click)="handleUnlock()"
      [disabled]="unlocking">
      @if (unlocking) {
      <i class="fas fa-spinner fa-spin"></i> Đang xử lý...
      } @else {
      <i class="fas fa-key"></i> MỞ KHÓA NGAY
      }
    </button>
  </div>
  } @else {
  <section class="question-list-section">
    <div class="section-header">
      <h2><i class="fas fa-layer-group"></i> Danh sách câu hỏi</h2>
      <span class="count-badge">{{ questions.length }} câu</span>
    </div>

    @if (questions.length > 0) {
    <div class="question-stack">
      @for (q of questions; track q.id; let i = $index) {
      <div class="q-card">

        <div class="q-header">
          <span class="q-index">Câu {{ i + 1 }}</span>
          <span class="difficulty-badge" [ngClass]="q.do_kho">
            {{ q.do_kho === 'DE' ? 'Dễ' : (q.do_kho === 'TRUNG_BINH' ?
            'Vừa' : 'Khó') }}
          </span>
        </div>

        <h3 class="q-text">{{ q.noi_dung }}</h3>

        @if (q.loai_noi_dung === 'HINH_ANH' && q.duong_dan_tep) {
        <div class="media-box image">
          <img [src]="getMediaUrl(q)" alt="Minh họa">
        </div>
        }
        @if (q.loai_noi_dung === 'AM_THANH' && q.duong_dan_tep) {
        <div class="media-box audio">
          <audio controls [src]="getMediaUrl(q)"></audio>
        </div>
        }

        <div class="options-grid">
          <div class="opt-item"
            [class.correct]="canViewAnswers() && q.dap_an_dung === 'A'">
            <span class="opt-label">A</span> {{ q.lua_chon_a }}
          </div>
          <div class="opt-item"
            [class.correct]="canViewAnswers() && q.dap_an_dung === 'B'">
            <span class="opt-label">B</span> {{ q.lua_chon_b }}
          </div>
          <div class="opt-item"
            [class.correct]="canViewAnswers() && q.dap_an_dung === 'C'">
            <span class="opt-label">C</span> {{ q.lua_chon_c }}
          </div>
          <div class="opt-item"
            [class.correct]="canViewAnswers() && q.dap_an_dung === 'D'">
            <span class="opt-label">D</span> {{ q.lua_chon_d }}
          </div>
        </div>

        @if (q.giai_thich && canViewAnswers()) {
        <div class="explanation-box">
          <div class="exp-icon"><i class="fas fa-lightbulb"></i></div>
          <div class="exp-content">
            <strong>Giải thích:</strong> {{ q.giai_thich }}
          </div>
        </div>
        }

        @if (isOwner() || isAdmin()) {
        <div class="q-actions">
          <button class="btn-action edit"
            (click)="navigateToEdit(q.id)">
            <i class="fas fa-pen"></i> Sửa
          </button>
          <button class="btn-action delete"
            (click)="onDeleteQuestion(q.id)">
            <i class="fas fa-trash"></i> Xóa
          </button>
        </div>
        }
      </div>
      }
    </div>

    @if (isPreview && !canViewAllQuestions()) {
    <div class="preview-lock-overlay">
      <div class="lock-content">
        <div class="lock-icon-small"><i class="fas fa-lock"></i></div>
        <h3>Bạn đang xem thử 3 câu đầu</h3>
        <p>Mở khóa ngay để truy cập toàn bộ {{ totalQuestions }} câu
          hỏi cực hay này!</p>
        <button class="btn-unlock-big" (click)="handleUnlock()"
          [disabled]="unlocking">
          @if (unlocking) {
          <i class="fas fa-spinner fa-spin"></i> Đang xử lý...
          } @else {
          <i class="fas fa-key"></i> MỞ KHÓA ({{ bo?.gia_mo_khoa }}
          Vàng)
          }
        </button>
      </div>
    </div>
    }

    @if (bo?.thuoc_khoa_hoc && bo?.khoa_hoc_id) {
    <div class="course-cta-card">
      <div class="course-cta-icon">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <div class="course-cta-content">
        <h3>Khóa học liên quan: {{ bo?.khoa_hoc_ten }}</h3>
        <p>
          Bộ câu hỏi này là một phần của khóa học.
          Vào khóa học để luyện toàn bộ {{ totalQuestions }} câu hỏi
          và theo dõi tiến độ của bạn.
        </p>
      </div>
      <button class="course-cta-button" (click)="goToCourse()">
        <i class="fas fa-arrow-right"></i> Đi đến khóa học
      </button>
    </div>
    }

    <!-- Rating Section -->
    @if (bo?.trang_thai === 'DA_DUYET' && !isOwner()) {
    <section class="rating-section">
      <h2><i class="fas fa-star"></i> Đánh giá bộ câu hỏi</h2>
      <app-danh-gia loaiDoiTuong="BO_CAU_HOI"
        [doiTuongId]="boCauHoiId" [allowRating]="canRateAndComment()">
      </app-danh-gia>

      @if (!canRateAndComment() && bo?.can_mo_khoa && !bo?.da_mo_khoa)
      {
      <div class="rating-unlock-hint">
        <i class="fas fa-info-circle"></i>
        Bạn cần mở khóa bộ câu hỏi này để có thể đánh giá
      </div>
      }
    </section>
    }

    } @else {
    <div class="empty-state">
      <img
        src="https://cdn-icons-png.flaticon.com/512/7486/7486747.png"
        alt="Empty">
      <p>Chưa có câu hỏi nào trong bộ này.</p>
      @if (isOwner() || isAdmin()) {
      <button class="btn-ghost-primary"
        (click)="goCreateQuestion()">Thêm câu hỏi ngay</button>
      }
    </div>
    }
  </section>
  }

</div>
} @else {
<div class="loading-screen">
  <div class="spinner"></div>
  <p>Đang tải dữ liệu...</p>
</div>
}